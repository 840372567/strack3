$(function(){function e(e,a,t){$.ajax({url:WebplayerPHP.PlayListTrack,type:"post",dataType:"json",data:{mtype:e,link_id:a},beforeSend:function(){$("#time_track").append(Strack.loading_dom("black","","tlist"))},success:function(e){var a="";e.forEach(function(e,t){a+=r(e,t)}),$("#time_track").html(a),m(),"reset"==t&&obj.PlayLoad()}})}function a(e){var a="";a+='<li class="meta-show">'+e.taskdata.task_name+'</li><li class="meta-show">'+e.taskdata.version+'</li><li class="meta-show">'+e.taskdata.t_type+'</li><li class="meta-show">'+e.taskdata.p_name+'</li><li class="meta-show">'+e.taskdata.artist+'</li><li class="meta-show">'+e.taskdata.status.status_name+'</li><li class="meta-show">'+e.taskdata.steps+'</li><li class="meta-show">'+e.metadata.m_width+"Ã—"+e.metadata.m_height+'</li><li class="meta-show">'+e.metadata.m_rate+"</li>",$("#metadata_show").html(a)}function t(e){var a=e.taskdata,t=parseInt(e.project_id),s=parseInt(e.link_type);$("#wpny_tname").html(a.task_name),$("#wpny_steps").html(a.steps),$("#wpny_status").html(Strack.widget_status_dom(a.status.status_icon,a.status.status_name,a.status.status_color)),$("#wpny_artist").html(a.artist),$("#wpny_thumb").html(Strack.NolazyTaskThumb(StrackPHP.TASK_THUMB,StrackPHP.pagetask,a.folder,a.thumb,e.task_id,a.project_id,a.item_type,"max")),i(e.v_id),n(t,e.task_id,s),l(t,s,e.task_id,10,1,"new"),$(".pyn-fd-wrap").css("height","calc(100% - "+(B+67)+"px)"),o()}function i(e){$.ajax({url:WebplayerPHP.GetScreenshot,type:"post",dataType:"json",data:{verid:e,page_session:Q},beforeSend:function(){$("#pyn_sst").append(Strack.loading_dom("black","","paint"))},success:function(e){var a="";e.length>0?e.forEach(function(e,t){a+=c(e)}):a+=s(),$("#sst_list").empty().append(a),$("#st-load_paint").remove()}})}function s(){return'<div class="pyn-st-null">'+WebplayerPHP.Screenshot_Null+"</div>"}function n(e,a,t){$("#pyn_editor").empty().append('<textarea id="editor" autocomplete="off"></textarea>'),Strack.G.Geditor.e_0=new Simditor({textarea:$("#editor"),placeholder:StrackPHP.Add_Note_Notice,toolbarHidden:!0,toolbartype:0,proj_id:e,task_id:a,link_type:t,panel_type:"webplayer",note_from:V,footer_control:!1,toolbar:["color","bold","emoji"],emoji:{imagePath:"images/emoji/"}}),Strack.G.Geditor.e_0.on("focus",function(e,a){Strack.HideNotereply(),$(".toolbar_0").show()})}function o(){$("#pyn_editor").find(".simditor").on("mresize",function(){var e=$(this).height()+B,a="calc(100% - "+e+"px)";$(".pyn-fd-wrap").css({height:a})})}function l(e,a,t,i,s,n){var o=$(".pyn-fd-wrap"),c=$("#side_task_comm");$.ajax({type:"POST",dataType:"json",url:WebplayerPHP.DataPtask,data:{dload:200,op_type:a,pid:e,t_id:t,tab:"activity",pagesize:i,pagenum:s,note_from:V,link_ver:x},beforeSend:function(){"new"==n&&(o.append(Strack.loading_dom("black","","notes")),c.empty())},success:function(o){var r=o.total;"new"==n&&($("#st-load_notes").remove(),$(".pyn-fd-wrap").on("scroll",function(){if((this.scrollTop||this.scrollTop)==(this.scrollHeight||this.scrollHeight)-(this.clientHeight||this.clientHeight)){s++;var n=Math.ceil(r/i);s<=n&&l(e,a,t,i,s,"more")}})),c.append(Strack.ShowAllNotes(o.rows,"main")),Strack.initPhotoSwipeFromDOM(".note_att"),Strack.UsersTips(".avatar-show","right")}})}function c(e){var a="",t=StrackPHP.UPLOADS+"/temp/"+e.img+"_temp.jpg";return a+='<a href="javascript:;" class="pyn-st-img aign-left" onclick="obj.paintThumb(this)" data-thumb="'+e.img+'" data-paintid="'+e.paint_id+'"><img src="'+t+'"><div class="pyn-st-frame">'+e.frame+"</div></a>"}function r(e,a){var t="";return t+='<a href="javascript:;" id="tkitem_'+e.media_id+'" class="time-track-item tk-no-load aign-left" onclick="obj.timeItemPlay(this)" data-index="'+a+'" data-vid="'+e.version_id+'" data-vnum="'+e.version+'" data-mid="'+e.media_id+'"  data-tid="'+e.task_id+'"><div class="track-item-header"><span class="track-item-sta myhome-status-dot aign-left" style="color: #00A7F7"><i class="icon-uniF04D"></i></span><span class="aign-right">'+e.version+'</span></div><div class="track-item-thumb">'+d(e.media_details.media_info)+'</div><div class="track-item-gress"><div id="progress_'+e.version_id+'"></div></div><div class="track-item-bottom"><span class="track-item-name aign-left">'+e.task_name+"</span></div></a>"}function d(e){var a=JSON.parse(e),t=a.thumb;return t?'<img src="'+StrackPHP.UPLOADS+"/Media/"+t+'">':'<img src="'+StrackPHP.IMG+'/thumb_media.jpg">'}function m(){var e=$("#time_track").find("a").length;$(".p-time-wrap").css("width",192*e)}function p(e,i){$("#mc_play").html('<i class="icon-uniEA46"></i>'),$("#preview_control").removeClass("preview-none"),I=e,R=D[e].metadata.m_type,x=D[e].v_id,h(D[e].metadata,D[e].v_id),i||(we||a(D[e]),t(D[e])),$("#current_ver").val(x)}function h(e,a){function t(){A.readyState==A.HAVE_ENOUGH_DATA&&(h.needsUpdate=!0),G.clear(),G.render(N,W)}function i(){O.update(),t(),requestAnimationFrame(i)}var s=$("#video_main"),n=e.m_width,o=e.m_height;switch(F=n,L=o,$(".time-track-item").removeClass("tkitem_ac"),$("#tkitem_"+e.m_id).addClass("tkitem_ac"),N&&s.empty(),parseInt(e.m_type)){case 10:A=document.createElement("img"),A.src=StrackPHP.UPLOADS+"/Media/"+e.m_path;break;case 20:A=document.createElement("video"),A.src=StrackPHP.UPLOADS+"/Media/"+e.m_path,j=VideoFrame({vobj:A,type:"vobj",frameRate:e.m_rate})}A.width=n,A.height=o;var l,c=s.width(),r=s.height();G=new THREE.WebGLRenderer({antialias:!0}),W=new THREE.PerspectiveCamera(45,c/r,.1,1e4),N=new THREE.Scene,N.add(W),W.position.z=872,G.setSize(c,r),document.getElementById("video_main").appendChild(G.domElement),M=new THREE.AmbientLight(16777215),N.add(M),O=new THREE.TrackballControls(W,G.domElement);var d,m,h=new THREE.Texture(A),_=new THREE.MeshLambertMaterial({map:h,side:THREE.FrontSide}),v=n/o;switch(v>v?(d=1280,m=d/v):(m=720,d=m*v),U=new THREE.Mesh(new THREE.PlaneGeometry(d,m),_),N.add(U),parseInt(e.m_type)){case 10:$e="images",i(),pe.slider({mode:"h",max:72,height:14,step:1,progressbar:!0,onComplete:function(e){if(e<72){(e/24).toFixed(2)}}}),u(1);break;case 20:$e="video",i(),A.load(),A.volume=ue?1:0,A.addEventListener("loadedmetadata",function(){A.play(),l=Strack.TimeToFrame(this.duration),pe.slider({mode:"h",max:l,height:14,step:1,progressbar:!0,onComplete:function(e){if(e<l){var a=(e/24).toFixed(2);A.currentTime=a}}})}),A.addEventListener("timeupdate",function(){var e=Strack.TimeToFrame(this.currentTime);pe.slider("setValue",e),Strack.SetMFrames(e,l)}),A.addEventListener("ended",function(){if(parseInt(I)<D.length-1)switch(_e){case"all_loop":case"onece":p(I+1,!1);break;case"self_loop":p(I,!0)}else switch(_e){case"all_loop":p(0,!1);break;case"onece":obj.vplay("#mc_play");break;case"self_loop":p(I,!0)}})}}function u(e){var a=1e3/Strack.G.FrameRates.film;v(),z=setInterval(function(){if(e++,pe.slider("setValue",e),Strack.SetMFrames(e,72),72==e)if(parseInt(I)<D.length-1)switch(_e){case"all_loop":case"onece":v(),p(I+1,!1);break;case"self_loop":e=1}else switch(_e){case"all_loop":v(),p(0,!1);break;case"onece":v();break;case"self_loop":e=1}},a)}function _(){switch(parseInt(R)){case 10:v();break;case 20:A.pause(),$("#mc_play").html('<i class="icon-uniEA45"></i>')}}function v(){z&&(window.clearInterval(z),z=null)}function f(){switch(R){case 10:break;case 20:A.play()}}function w(e){var a=$(e).width(),t=$(e).height(),i=a/t;$(e).find("canvas").css({width:a,height:t}),W.position.z=872,W.aspect=i,W.updateProjectionMatrix(),U.position.set(O.target.x,O.target.y,0),G.setSize(a,t)}function k(){var e=$("#mc_play");e.hasClass("on_play")&&e.removeClass("on_play").html('<i class="icon-uniEA45"></i>')}function y(){var e=$("#r_handle"),a=$("#note_panel"),t=$("#left_panel"),i=$("#note_name"),s=$("#note_info");e.hasClass("r_panel_open")?(a.css("width",40),t.css("width","calc(100% - 48px)"),e.html('<i class="icon-uniF0D9"></i>').removeClass("r_panel_open"),s.hide(),re.hide(),i.show()):(a.css("width",660),t.css("width","calc(100% - 668px)"),e.html('<i class="icon-uniF0DA"></i>').addClass("r_panel_open"),i.hide(),"yes"==he?s.show():re.show())}function g(){var e=$("#time_panel"),a=$("#t_panel_main"),t=$("#timeline_name"),i=$("#pt_top"),s=$("#timeline_warp");e.hasClass("t_panel_open")?(a.css("height",40),i.css("height","calc(100% - 48px)"),e.html('<i class="icon-uniE76C"></i>').removeClass("t_panel_open"),t.show(),s.hide()):(a.css("height",260),i.css("height","calc(100% - 268px)"),e.html('<i class="icon-uniE76B"></i>').addClass("t_panel_open"),t.hide(),s.show())}function P(e){$("#preview_paint").hide(),e.removeClass("mc-active"),$(".preview-main").css("width","100%")}function b(e){e.addClass("mc-active"),$("#preview_paint").show(),$(".preview-main").css("width","calc(100% - 34px)")}function S(e,a){var t=document.createElement("canvas");t.width=e,t.height=a,t.getContext("2d").drawImage(A,0,0,t.width,t.height);var i=document.createElement("img");return i.src=t.toDataURL(),i.src}if(obj={vpainter:function(e){var a,t=$(e);if(t.hasClass("mc-active")){ve=!0,pe.slider("enable"),pe.slider("setValue",fe);var i=$("#video_paint").wPaint("image");P(t),$("#vp_wrap").hide(),a="images"==$e?1:Strack.TimeToFrame(A.currentTime),$("#video_paint").wPaint("clearUndo"),$.ajax({url:WebplayerPHP.SaveScreenshot,type:"post",dataType:"json",data:{imgData:i,verid:x,cframe:a,page_session:Q,upload:StrackPHP.UPLOADS},success:function(e){$("#sst_list").find(".pyn-st-null").remove(),$("#sst_list").append(c(e))}})}else{"images"==$e&&v(),ve=!1,fe=pe.slider("getValue"),pe.slider("disable"),_(),$("#mc_play").removeClass("on_play").html('<i class="icon-uniEA45"></i>'),b(t);var s,n,o,l=$("#vp_wrap"),r=l.height(),d=l.width(),m=F/L,p=d/r;p>m?(s=r,n=Math.round(s*m)):(n=d,s=Math.round(n/m)),o=(d-n)/2,$("#video_paint").css({width:n,height:s,left:o}),$("#video_paint canvas").attr({width:n,height:s}),$("#video_paint").wPaint("imageBg",S(n,s)),$("#vp_wrap").show()}},vplay:function(e){if(A&&ve)if($(e).hasClass("on_play")){switch($e){case"images":v();break;case"video":_()}$(e).removeClass("on_play").html('<i class="icon-uniEA45"></i>')}else{switch($e){case"images":u(pe.slider("getValue"));break;case"video":A.play(),f()}$(e).addClass("on_play").html('<i class="icon-uniEA46"></i>')}else layer.msg(WebplayerPHP.On_Screenshot,{icon:2,time:1200,anim:6})},cvoice:function(e){var a=$(e);a.hasClass("voice-on")?(a.html('<i class="icon-uniEA53"></i>').removeClass("voice-on").addClass("voice-off"),A.volume=0,ue=!1):(a.html('<i class="icon-uniEA50"></i>').removeClass("voice-off").addClass("voice-on"),A.volume=1,ue=!0)},vfullscreen:function(e){window.fullScreenApi.supportsFullScreen&&(window.fullScreenApi.isFullScreen()?($("#mc_fullscreen").html('<i class="icon-uniE74B"></i>'),window.fullScreenApi.cancelFullScreen()):($("#mc_fullscreen").html('<i class="icon-uniE9B5"></i>'),window.fullScreenApi.requestFullScreen(document.getElementById("view_main"))))},ShowMeta:function(e){var a=$("#mc_metadata");a.hasClass("meta_ac")?a.removeClass("meta_ac").hide():a.addClass("meta_ac").show()},vloopset:function(e){var a=$(e),t=$("#mc_loop"),i=a.attr("data-vloop");switch(parseInt(i)){case 1:a.attr("data-vloop",2),t.html('<i class="icon-uniF178"></i>'),_e="onece";break;case 2:a.attr("data-vloop",3),t.html('<i class="icon-uF0030"></i>'),_e="self_loop";break;case 3:a.attr("data-vloop",1),t.html('<i class="icon-uniEA56"></i>'),_e="all_loop"}},timeItemPlay:function(e){var a=$(e).data("index");$(e).hasClass("tk-no-load")?layer.msg(WebplayerPHP.Please_Load_Track,{icon:2,time:1200,anim:6}):ve?(x=$(e).data("vid"),v(),_(),p(a,!1)):layer.msg(WebplayerPHP.On_Screenshot,{icon:2,time:1200,anim:6})},ResetToTimeline:function(a){var t=$(a).data("listid");_(),e("lists",t,"reset")},PlayLoad:function(){if(ve){v(),A&&_();var e=[];$(".time-track-item").each(function(){$(this).removeClass("tk-no-load"),e.push({vid:$(this).data("vid"),mid:$(this).data("mid"),tid:$(this).data("tid"),vnum:$(this).data("vnum")})}),e.length>0?($("#mc_load").addClass("mc-load"),$.ajax({url:WebplayerPHP.LoadTimeTrack,type:"post",dataType:"json",data:{tk_list:JSON.stringify(e),upload:StrackPHP.UPLOADS},beforeSend:function(){$("#view_main").append(Strack.loading_dom("black","","pload"))},success:function(e){D=e,he="yes",re.hide(),de.show(),p(0,!1),$("#st-load_pload").remove()}})):layer.msg(WebplayerPHP.Timeline_Is_Empty,{icon:2,time:1200,anim:6})}else layer.msg(WebplayerPHP.On_Screenshot,{icon:2,time:1200,anim:6})},paintThumb:function(e){$(e).hasClass("st-selected")?$(e).removeClass("st-selected"):$(e).addClass("st-selected")},RefreshNote:function(e,a,t,i,s,n){l(e,a,t,i,s,n)},AddNote:function(e,a,t,i,s){var n=Strack.G.Geditor["e_"+a].getValue(),o=Strack.G.Geditor["e_"+a].body,l=$(".fieldsbar_"+a),c=$(".ed_retask_"+a),r=$("#nodeimg_"+a),d=[],m=StrackPHP.pagetask.replace(".html",""),p=$(e).data("from");if(n.length>0){var h=[],u=[],_=[],v="",f=20,w=0;o.find("a").each(function(){$(this).hasClass("todo_show")?(u.push($(this).data("todo")),_.push($(this).data("issues"))):$(this).hasClass("simditor-mention")&&h.push($(this).data("uid"))}),l.find(".ed_fiedlds").each(function(){var e=$("#"+$(this).attr("id")).combobox("getValue");switch($(this).attr("data-input")){case"ispublic":v=e;break;case"note_type":f=e;break;case"note_link":w=e}}),c.find("input").each(function(){$(this).is(":checked")&&d.push($(this).attr("data-taskid"))});var k=[];switch(r.find("img").each(function(){k.push($(this).data("img"))}),$("#pyn_sst").length>0&&$(".pyn-st-img").each(function(){$(this).hasClass("st-selected")&&k.push($(this).data("thumb"))}),p){case"review_inside":case"review_client":w=$("#current_ver").val();break;default:Strack.G.Gplaylistid=0}$.ajax({type:"POST",url:WebplayerPHP.TaskNotesAdd,data:{notes:n,project_id:s,parent_id:a,link_type:i,link_id:t,atcc:h.join(","),todo:u.join(","),issues:_.join(","),ispub:v,otype:f,linkv:w,retasks:d.join(","),base_url:m,img_arr:k.join(","),note_from:p,plist_id:Strack.G.Gplaylistid,up_url:StrackPHP.UPLOADS,ctEmail:q,ctplistId:J,ctpsessionId:K},beforeSend:function(){$.messager.progress({title:StrackPHP.Waiting,msg:StrackPHP.loading})},success:function(a){switch($.messager.progress("close"),$(e).attr("data-panel")){case"side":Strack.TasknodeAjax($("#infopanel_main"),i,s,t,10,1,"new");break;case"main":Strack.NotesAjax(s,i,t,10,1,"new");break;case"webplayer":obj.RefreshNote(s,i,t,10,1,"new")}}})}else layer.msg(StrackPHP.Task_Notes_NULL,{icon:2,time:1200,anim:6})}},"yes"==PARSE_VAR.client_allow){var E,H,C,T,A,j,x,R,I,F,L,D,G,W,N,M,O,U,V,B,z,q=PARSE_VAR.email,J=PARSE_VAR.ids,K=PARSE_VAR.plist_session_id,X=$("#m_type").val(),Y=$("#m_ids").val(),Q=($("#m_session").val(),$("#m_psession").val()),Z=0,ee=$("#r_handle"),ae=$("#note_panel"),te=$("#left_panel"),ie=$("#paint_show"),se=$("#time_panel"),ne=$("#t_panel_main"),oe=$("#timeline_name"),le=$("#pt_top"),ce=$("#note_name"),re=$("#player_note_null"),de=$("#note_info"),me=$("#timeline_warp"),pe=$("#preview_slider"),he=$("#player_isload").val(),ue=!0,_e="all_loop",ve=!0,fe=0,$e="none",we=!1;WebplayerPHP.Playlist_Name_NULL,WebplayerPHP.Not_Select_Project;!function(a,t,i){V="review_client",we=!0,Z=t,B=116,Strack.G.Gplaylistid=Z,e(a,t)}(X,Y),Strack.CancelGload(),function(){ie.on("click",function(){P($("#mc_paint"))}),se.on("click",function(){g()}),oe.on("click",function(){g()}),ee.on("click",function(){y()}),ce.on("click",function(){y()}),$(".center-handle").on("mousedown",function(e){e.preventDefault(),C=document.body.clientHeight-48,$(".webplayer-wrap").on("mousemove",function(e){var a=document.body.clientHeight-e.pageY;T=a<140?40:a>=C?C:a;var t=T+8;T<140?(ne.css("height",40),le.css("height","calc(100% - 48px)"),se.html('<i class="icon-uniE76C"></i>').removeClass("t_panel_open"),oe.show(),me.hide()):(ne.css("height",T),le.css("height","calc(100% - "+t+"px)"),se.html('<i class="icon-uniE76B"></i>').addClass("t_panel_open"),oe.hide(),me.show())}).on("mouseup",function(e){$(this).off("mousemove")})}),$(".right-handle").on("mousedown",function(e){e.preventDefault(),E=880,$(".webplayer-wrap").on("mousemove",function(e){var a=document.body.clientWidth-e.pageX;H=a<660?30:a>=E?E:a;var t=H+8;H<660?(ae.css("width",40),te.css("width","calc(100% - 48px)"),ee.html('<i class="icon-uniF0D9"></i>').removeClass("r_panel_open"),de.hide(),re.hide(),ce.show()):(ae.css("width",H),te.css("width","calc(100% - "+t+"px)"),ee.html('<i class="icon-uniF0DA"></i>').addClass("r_panel_open"),ce.hide(),"yes"==he?de.show():re.show())}).on("mouseup",function(e){$(this).off("mousemove")})})}(),function(){$("#video_paint").wPaint({fontSizeMax:25,menuDom:"#paint_menu",menuOrientation:"vertical",imageBg:StrackPHP.PUBLIC+"/images/screenshot.png"}),$("body").append(Strack.PhotoSwipeButtonDOM())}(),function(){$("#preview_main").on("mresize",function(){N&&w("#video_main")})}(),function(){$(document).on("keydown",function(e){if(N&&ve&&0==$("#pyn_editor").find(".focus").length)switch(e.keyCode){case 32:obj.vplay($("#mc_play"));break;case 37:"video"==$e?(k(),j.seekBackward(1)):layer.msg(WebplayerPHP.Play_Media_Is_Img,{icon:2,time:1200,anim:6});break;case 39:"video"==$e?(k(),j.seekForward(1)):layer.msg(WebplayerPHP.Play_Media_Is_Img,{icon:2,time:1200,anim:6});break;case 70:w("#video_main")}})}()}else Strack.CancelGload(),$(".webplayer-wrap").empty().append(function(){var e=null;return e='<div class="login-error">',e+='<div class="login-error-title">'+StrackPHP.Illegal_Operation+"</div>",e+='<div class="login-error-content">',e+='<div class="login-error-icon"><i class="icon-uniEA30"></i></div>',e+="<p>"+WebplayerPHP.Client_Review_Error1+"</p>",e+="<p>"+WebplayerPHP.Client_Review_Error2+"</p>",e+="</div>",e+="</div>"}())});