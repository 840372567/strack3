$(function(){function i(t,e,d,n){$.ajax({type:"POST",url:BiddingPHP.getBiditemData,dataType:"json",data:{filter:JSON.stringify(t),pageNumber:e,pageSize:d},beforeSend:function(){$("#biditem_list").append(Strack.loading_dom("white","","lbid"))},success:function(t){var l="",c=$("#bidi_pagination");switch(t.total>0?t.data.forEach(function(i){l+=s(i)}):l='<div class="datagrid-empty-no">'+StrackPHP.Datagird_No_Data+"</div>",n){case"new":c.pagination({total:t.total,pageSize:d,pageList:[e,d],onSelectPage:function(t,e){i(o,t,e,"reload")}});break;case"reload":default:c.pagination("refresh",{total:t.total,pageNumber:e})}$("#biditem_list").empty().append(l),a(),$("#st-load_lbid").remove()}})}function t(i){$.ajax({type:"POST",url:BiddingPHP.getBidestData,dataType:"json",data:{bitemid:i},beforeSend:function(){$("#biditem_est_"+i).append(Strack.loading_dom("white","","lbid"))},success:function(t){var d=n(i,t);$("#est_grid_"+i).empty().append(d.estlist),a(),e(i),$("#st-load_lbid").remove()}})}function e(i){var t=$("#biditem_est_"+i),e=parseInt(t.find(".est_discount").val()),d=parseInt(t.find(".est_total").val()),a=0,s=0;$("#est_grid_"+i).find(".est-input-item").each(function(){a+=parseInt($(this).find(".est_units").val()),s+=parseInt($(this).find(".est-input-rate").html())}),t.find(".bidi_unit_price").html(s),t.find(".bidi_total_price").html(s*(e/100)*d),t.find(".bidi_item_day").html(a),t.find(".bidi_item_days").html(a*d)}function d(){$(".bid_i_input").off("focus").off("blur")}function a(){d(),$(".bid_i_input").on("focus",function(){m=$(this).val()}).on("blur",function(){var i=$(this),t=i.attr("data-field"),d=i.attr("data-linkid"),a=i.attr("data-itemid"),s=i.val();$.ajax({type:"POST",url:BiddingPHP.updateBiditem,dataType:"json",data:{linkid:d,field:t,value:s},success:function(d){if(404==parseInt(d.status))i.val(m),Strack.top_message({bg:"r",msg:d.message});else switch(Strack.top_message({bg:"g",msg:d.message}),t){case"item_units":case"discount":case"est_units":e(a)}}})})}function s(i){var t=n(i.bid_item_id,i.BiddingEstimate);return'<div id="bid_item_'+i.bid_item_id+'" class="biditem-item"><div class="biditem-bnt aign-left"><a href="javascript:;" class="bidi-bnt-del" onclick="obj.deleteBiditem(this)" data-bitemid="'+i.bid_item_id+'"><i class="icon-uniE6DB"></i></a><div class="bidi-bnt-text">'+StrackPHP.Type+'</div><div class="bidi-bnt-text">'+StrackPHP.Name+'</div><div class="bidi-bnt-text">'+StrackPHP.Duration+'</div></div><div class="biditem-info aign-left"><div class="bidi-info-item"><div class="bidi-info-number">'+i.bid_item_id+'</div></div><div class="bidi-info-item"><div class="bidi-info-number">'+i.bid_type+'</div></div><div class="bidi-info-item"><input class="bidi-input bid_i_input" value="'+i.bid_item_name+'" data-linkid="'+i.bid_item_id+'" data-field="bid_item_name"  autocomplete="off"></div><div class="bidi-info-item"><input class="bidi-input bid_i_input" value="'+i.duration+'" data-linkid="'+i.bid_pend_id+'" data-field="duration"  autocomplete="off"></div><div class="bidi-info-img">'+Strack.DataGridNoThumb("BiddingThumb",i.thumb,10010,"max","","","no")+'</div><div class="bidi-info-bottom"><a href="javascript:;" class="st-dialog-button st-button-base button-dgcel" onclick="obj.updateBidpendThumb(this);" data-bidpendid="'+i.bid_pend_id+'">'+StrackPHP.UploadImage+'</a></div></div><div class="biditem-describe aign-left"><div class="bidi-desc-title">'+StrackPHP.Description+'</div><div class="bidi-desc-item"><textarea class="bidi-textarea bid_i_input" data-linkid="'+i.bid_item_id+'" data-field="description"  autocomplete="off">'+i.description+'</textarea></div><div class="bidi-desc-title">'+BiddingPHP.Sence_Description+'</div><div class="bidi-desc-item"><textarea class="bidi-textarea bid_i_input" data-linkid="'+i.bid_item_id+'" data-field="sence_description"  autocomplete="off">'+i.sence_description+'</textarea></div><div class="bidi-desc-title">'+BiddingPHP.VFX_Description+'</div><div class="bidi-desc-item"><textarea class="bidi-textarea bid_i_input" data-linkid="'+i.bid_item_id+'" data-field="vfx_description"  autocomplete="off">'+i.vfx_description+'</textarea></div><div class="bidi-desc-title">'+StrackPHP.Remark+'</div><div class="bidi-desc-item"><textarea class="bidi-textarea bid_i_input" data-linkid="'+i.bid_item_id+'" data-field="bid_notes"  autocomplete="off">'+i.bid_notes+'</textarea></div></div><div id="biditem_est_'+i.bid_item_id+'" class="biditem-estimate aign-left"><div class="bidi-est-title"><div class="bidi-est-show aign-left">'+BiddingPHP.Biditems+'</div><div class="bidi-est-tools aign-left"><a href="javascript:;" class="bidi-est-bnt aign-left" onclick="obj.addBidEstimate(this)"  data-bitemid="'+i.bid_item_id+'"><i class="icon plus"></i></a></div></div><div class="bidi-est-grid"><div class="est-main-wrap est-main-head"><div class="est-item-close aign-left"></div><div class="est-item-tasks aign-left">'+StrackPHP.Tasks+'</div><div class="est-item-type aign-left">'+StrackPHP.Type+'</div><div class="est-item-units aign-left">'+StrackPHP.Units+'</div><div class="est-item-notes aign-left">'+StrackPHP.Remark+'</div><div class="est-item-rate aign-left">'+BiddingPHP.EstRate+'</div><div class="est-item-total aign-left">'+StrackPHP.Total+'</div></div><div id="est_grid_'+i.bid_item_id+'" class="est-grid-items">'+t.estlist+'</div></div><div class="bidi-est-count"><div class="bidi-est-name aign-left">'+BiddingPHP.Quantity+' :</div><div class="bidi-est-input aign-left"><input type="text" class="bid_i_input est_total" value="'+i.item_units+'" data-linkid="'+i.bid_item_id+'" data-itemid="'+i.bid_item_id+'" data-field="item_units"  autocomplete="off"></div><div class="bidi-est-name aign-left">'+BiddingPHP.Unit_Price+' :</div><div class="bidi-est-content bidi_unit_price aign-left">'+t.unit_price+'</div><div class="bidi-est-name aign-left">'+StrackPHP.Discount+' :</div><div class="bidi-est-input aign-left"><input type="text" class="bid_i_input est_discount" value="'+i.discount+'" data-linkid="'+i.bid_item_id+'" data-itemid="'+i.bid_item_id+'" data-field="discount"  autocomplete="off"> %</div><div class="bidi-est-name aign-left">'+BiddingPHP.Total_Price+' :</div><div class="bidi-est-content bidi_total_price aign-left">'+t.unit_price*(parseInt(i.discount)/100)*parseInt(i.item_units)+'</div></div><div class="bidi-est-total"><div class="bidi-est-name aign-left">'+BiddingPHP.Item_Days+' :</div><div class="bidi-est-content bidi_item_day aign-left">'+t.item_day+'</div><div class="bidi-est-name aign-left">'+StrackPHP.Days+' :</div><div class="bidi-est-content bidi_item_days aign-left">'+t.item_day*parseInt(i.item_units)+"</div></div></div></div>"}function n(i,t){var e="",d=0,a=0;return t.length>0?t.forEach(function(t){d+=parseInt(t.est_cost)*parseInt(t.est_units),a+=parseInt(t.est_units),e+=l(i,t)}):e='<div class="datagrid-empty-no">'+StrackPHP.Datagird_No_Data+"</div>",{estlist:e,unit_price:d,item_day:a}}function l(i,t){var e="";return e+='<div id="est_item_'+t.bid_est_id+'" class="est-main-wrap est-input-item"><a href="javascript:;" class="est-input-close aign-left" onclick="obj.deleteEstitem(this)" data-estid="'+t.bid_est_id+'" data-bitemid="'+i+'"><i class="icon-uniE6DB"></i></a><div class="est-input-tasks aign-left">'+t.est_name_val+'</div><div class="est-input-type aign-left">'+t.est_type_name+'</div><div class="est-input-units aign-left"><input type="text" class="bid_i_input est_units" value="'+t.est_units+'" data-linkid="'+t.bid_est_id+'" data-itemid="'+i+'" data-field="est_units" data-bitemid="'+i+'" autocomplete="off"></div><div class="est-input-notes aign-left"><input type="text" class="bid_i_input" value="'+t.est_notes+'" data-linkid="'+t.bid_est_id+'" data-itemid="'+i+'" data-field="est_notes"  data-bitemid="'+i+'" autocomplete="off"></div><div class="est-input-rate aign-left">'+t.est_cost+'</div><div class="est-input-total aign-left">'+parseInt(t.est_units)*parseInt(t.est_cost)+"</div></div>"}obj={addBidItem:function(t){var e=$(t).data("pid"),d=($(t).data("grid"),{type:"biditem",pid:e,custom:"yes",multi:"no",etype:10030,upmod:"newBiditem"});Strack.open_dialog("dialog",{title:BiddingPHP.Add_Bidding_Item,width:560,height:360,content:Strack.dialog_dom({type:"normal",hidden:[{case:101,id:"Mup_type",type:"hidden",name:"up_type",valid:1,value:d.upmod},{case:101,id:"Mproject_id",type:"hidden",name:"project_id",valid:1,value:e},{case:101,id:"Mbid_id",type:"hidden",name:"bid_id",valid:1,value:u},{case:101,id:"Mtype",type:"hidden",name:"type",valid:1,value:d.etype},{case:101,id:"Mitype",type:"hidden",name:"type",valid:1,value:"new"}],items:[{case:1,id:"Mup_fields",type:"text",lang:StrackPHP.Fields,name:"fields",valid:1,value:""}],update:!0,footer:[{obj:"BatchUpdate",type:5,title:StrackPHP.Submit},{obj:"dialog_cancel",type:8,title:StrackPHP.Cancel}]}),inits:function(){$("#Mup_fields").combobox({url:StrackPHP.EditFields,width:350,valueField:"id",textField:"lang",multiple:!0,value:"",queryParams:d,onSelect:function(i){if(0==$("#dgup_i_"+i.id).length){var t=Strack.BatchUpItem(i,"new");$("#st_dgup").append(t.item_dom),Strack.BatchItemInit(i,e,10030,t.id,d.type,i)}},onUnselect:function(i){$.inArray(i.id,[10031])<0?$("#dgup_i_"+i.id).remove():($(this).combobox("select",i.id),layer.msg(StrackPHP.Must_Field,{icon:2,time:1200,anim:6}))},onLoadSuccess:function(){$(this).combobox("select",10031)}})},close:function(){i(o,1,100,"reload")}})},deleteBiditem:function(i){var t=$(i).data("bitemid");$.messager.confirm(StrackPHP.Confirmation_Box,BiddingPHP.Bidding_Item_Delete_Notice,function(i){i&&$.ajax({type:"POST",url:BiddingPHP.deleteBiditem,dataType:"json",data:{project_id:r,bitem_id:t},beforeSend:function(){$("#biditem_list").append(Strack.loading_dom("white","","lbid"))},success:function(i){$("#bid_item_"+t).remove(),Strack.top_message({bg:"g",msg:BiddingPHP.Bidding_Item_Delete_SC}),$("#st-load_lbid").remove()}})})},addBidEstimate:function(i){var e=$(i).data("bitemid"),d={type:"biditemEst",pid:r,custom:"yes",multi:"no",etype:10040,upmod:"newBiditemEst"};Strack.open_dialog("dialog",{title:BiddingPHP.AddNewEstimate,width:560,height:360,content:Strack.dialog_dom({type:"normal",hidden:[{case:101,id:"Mup_type",type:"hidden",name:"up_type",valid:1,value:d.upmod},{case:101,id:"Mproject_id",type:"hidden",name:"project_id",valid:1,value:r},{case:101,id:"Mbiditem_id",type:"hidden",name:"biditem_id",valid:1,value:e},{case:101,id:"Mtype",type:"hidden",name:"type",valid:1,value:d.etype},{case:101,id:"Mitype",type:"hidden",name:"type",valid:1,value:"new"}],items:[{case:1,id:"Mup_fields",type:"text",lang:StrackPHP.Fields,name:"fields",valid:1,value:""}],update:!0,footer:[{obj:"BatchUpdate",type:5,title:StrackPHP.Submit},{obj:"dialog_cancel",type:8,title:StrackPHP.Cancel}]}),inits:function(){$("#Mup_fields").combobox({url:StrackPHP.EditFields,width:350,valueField:"id",textField:"lang",multiple:!0,value:"",queryParams:d,onSelect:function(i){if(0==$("#dgup_i_"+i.id).length){var t=Strack.BatchUpItem(i,"new");$("#st_dgup").append(t.item_dom),Strack.BatchItemInit(i,r,10040,t.id,d.type,i)}},onUnselect:function(i){$.inArray(i.id,[10040])<0?$("#dgup_i_"+i.id).remove():($(this).combobox("select",i.id),layer.msg(StrackPHP.Must_Field,{icon:2,time:1200,anim:6}))},onLoadSuccess:function(){$(this).combobox("select",10040)}})},close:function(){t(e)}})},deleteEstitem:function(i){var t=$(i).data("estid"),d=$(i).data("bitemid");$.messager.confirm(StrackPHP.Confirmation_Box,BiddingPHP.Estimate_Delete_Comfirm,function(i){i&&$.ajax({type:"POST",url:BiddingPHP.deleteBidest,dataType:"json",data:{project_id:r,est_id:t},beforeSend:function(){$("#bid_item_"+d).append(Strack.loading_dom("white","","ibid"))},success:function(i){Strack.top_message({bg:"g",msg:BiddingPHP.Estimate_Delete_SC}),$("#est_item_"+t).remove(),e(d),$("#st-load_ibid").remove()}})})},updateBidpendThumb:function(i){var t=$(i).data("bidpendid");Strack.change_item_thumb(10010,t,r,"biditem")},reloadBiditemList:function(){i(o,1,100,"reload")},filterAction:function(t){var e=$("#search_val_biditem").val();o.extra.item_vfx=["LIKE","%"+e+"%"],i(o,1,100,"reload")}};var c=$(".projpage-main");if(PARSE_VAR.auth.authority){var o,m,r=$("input[name=proj_id]").val(),p=$("input[name=p_type]").val(),u=$("input[name=bid_id]").val(),_=Strack.verify_project_data(r);_>0?(c.show(),Strack.project_sub_menu(r,p),$("#url_bidlist").append('<a href="'+Strack.remove_html_ext(StrackPHP.ProjBidding)+"/"+r+'.html" target="_blank"><span class="stp-title">'+BiddingPHP.Offer_Sheet+"</span></a>"),o=Strack.build_filter({project_id:["eq",r],bid_id:["eq",u]},{},{},{},"and",{},{},[{sortName:"created",sortOrder:"desc"}]),i(o,1,100,"new")):c.empty().append(Strack.ProjWarn(StrackPHP.Project_None_Warning)).show()}else c.empty().append(Strack.ProjWarn(StrackPHP.NoPermission)).show()});