$(function(){function e(e,a){t(Strack.build_filter({project_id:["eq",e],active:["eq",1]},{},{},{},"and",{},{},[{sortName:"created",sortOrder:"desc"}]),e,a,j,D,"new"),_()}function t(e,i,c,o,r,n){var l=$("#lseq_list");Strack.G.Gfilter_list.sequences=e,$.ajax({type:"POST",url:ProjPHP.DataSeqList,data:{filter:JSON.stringify(e),project_id:i,type:c,pagenum:o,pagesize:r},beforeSend:function(){$(".seq-left-wrap").append(Strack.loading_dom("white","","lseq"))},success:function(d){var u=JSON.parse(d),p=u.total,m="";if(p>0)if(w)switch(u.rows.forEach(function(e){m+=a(e)}),n){case"new":l.on("scroll",function(){if((this.scrollTop||this.scrollTop)==(this.scrollHeight||this.scrollHeight)-(this.clientHeight||this.clientHeight)){o++;var a=Math.ceil(p/r);o<=a&&t(e,i,c,o,r,"more")}}),l.empty().append(m);break;case"more":l.append(m)}else{var _=e.sort[0].sortName,h="";switch(_){case"status_id":h="status_name";break;case"epis_id":h="epis_name";break;default:h=_}var f=Strack.array_group(u.rows,h);for(var S in f){var k="";f[S].forEach(function(e){k+=a(e)}),m+=s(S,k)}l.off("scroll"),l.empty().append(m)}else l.empty().append('<div class="datagrid-empty-no">'+Strack.DataNullTip(6020)+"</div>");$("#st-load_lseq").remove()}})}function a(e){var t="";return t+='<div class="seq-left-items"><a href="javascript:;" class="list-item-main" onclick="obj.ShowItem(this)" data-seqid="'+e.sequenceid+'"><div id="thumb_left_60_'+e.sequenceid+'" class="sleft-items-thumb">'+i(e.thumb)+'</div><div class="sleft-items-content"><div class="sleft-items-ctop"><span class="items-ctop-icon aign-left"><i class="icon-small_shots icon-left-p"></i></span><span class="items-ctop-title aign-left text-ellipsis">'+e.seq_name+'</span></div><div class="sleft-items-cbottom"><span class="items-ctop-status aign-left"><i class="'+e.status_icon+' icon-left" style="color:#'+e.status_color+'"></i>'+e.status_name+"</span></div></div></a></div>"}function i(e){var t=JSON.parse(e);return t.thumb?'<img src="'+StrackPHP.UPLOADS+"/SequencesThumb/"+t.thumb+'_min.jpg">':'<div class="task-thumb-null">'+Strack.ProjTaskIcon(y)+"</div>"}function s(e,t){var a="";return a+='<div class="seq-left-group"><a href="javascript:;" class="sleft-ghead" onclick="obj.ToggleGroup(this)"><i class="icon-uniF106 sidebar-icon icon-left"></i>'+e+'</a><div class="sleft-gitem">'+t+"</div></div>"}function c(e,t,a){var i=Strack.build_filter({project_id:["eq",e],active:["eq",1]},{},{},{},"and",{},{},[{sortName:"created",sortOrder:"desc"}]);Strack.G.Gfilter_data.sequences=i,$("#data_seqs").datagrid({url:ProjPHP.DataSequences,fitColumns:!1,height:Strack.panel_height(".pseqlist",0),rowheight:49,differhigh:!1,singleSelect:!1,adaptive:{dom:".pseqlist",min_width:510,exth:0,domresize:1},DragSelect:!0,DataNull:Strack.DataNullTip(t),queryParams:{filter:JSON.stringify(i),ptype:t,pid:e},frozenColumns:[[{field:"sequenceid",title:StrackPHP.SequenceId,checkbox:!0}]],columns:[a],toolbar:"#tb_list",pagination:!0,pageSize:100,pageList:[100,200,300,400,500,"All"],pageNumber:1,pagePosition:"bottom",remoteSort:!1,onDblClickRow:function(t,a){Strack.SideColumnOpen(a.sequenceid,60,60,e,"data_seqs")},onRowContextMenu:function(e,t,a){Strack.grid_clipboard(e.target),e.preventDefault(),$("#st_menu_sequences").menu("show",{left:e.pageX,top:e.pageY})}})}function o(e,t){$.ajax({type:"POST",url:StrackPHP.DynamicFields,dataType:"json",data:{project_id:e,type:t},success:function(a){var i=[];a.forEach(function(e,t){e&&i.push(Strack.DynamicFieldset(60,e,t,""))}),c(e,t,i)}})}function r(e,t,a){n(e,t,a),l(e,t,a),Strack.AjaxHfields(a,t,e,StrackPHP.DomSHfields,"sequences",0),$(".special.cards .image").dimmer({on:"hover"})}function n(e,t,a){$.ajax({type:"POST",url:ProjPHP.LoadItemImg,data:{seq_id:t,project_id:e,type:a},beforeSend:function(){$(".item-thumb-warp").prepend(Strack.loading_dom("white","","thumb"))},success:function(e){var i=JSON.parse(e),s=$("#thumb_show_"+a+"_"+t),c="";$("#st-load_thumb").remove(),"no"==PARSE_VAR.rules.upload_thumb.allow&&$("#seq_up_thumb").empty().html(StrackPHP.Thumbnail),400==parseInt(i.status)?(c='<div class="task-thumb-null">'+Strack.ProjTaskIcon(a)+"</div>",s.empty().append(c)):(c=StrackPHP.UPLOADS+"/SequencesThumb/"+i.thumb+"_max.jpg",s.empty().append('<img src="'+c+'">'))}})}function l(e,t,a){$.ajax({type:"POST",url:ProjPHP.LoadItemBase,data:{seq_id:t,project_id:e,type:a},success:function(e){var a=JSON.parse(e),i="",s="";i+=Strack.ProjTaskIcon(a.type),i+='<span class="taskm_content">'+a.seq_name+"</span>",$("#seq_d_name").empty().append(i);var c=d(a.type,a.project_id,a.seq_name,a.epis_name);$(".item-breadcrumb-left").empty().append(c),"yes"==PARSE_VAR.rules.sequence_action.allow&&(s=' <a href="javascript:;" class="mini ui button details-icon down-panel" onclick="Strack.ClientAction(this)" data-type="60" data-linkid="'+t+'"> <i class="icon-uniE6BB down-panel"></i> </a>'),$(".item-breadcrumb-right").empty().append(s)}})}function d(e,t,a,i){var s="";return s+='<div class="ui small breadcrumb">',s+=i||Strack.ProjSubName(e),s+='<i class="right angle icon divider"></i>',s+='<div class="active section">'+a+"</div>",s+="</div>",s+="</div>",s+="</div>"}function u(e,t,a){$.ajax({type:"POST",url:StrackPHP.DynamicFields,dataType:"json",data:{project_id:e,type:t},success:function(t){var i=[];t.forEach(function(t,a){t&&i.push(Strack.DynamicFieldset(70,t,a,{pid:e}))}),p(70,e,a,i)}})}function p(e,t,a,i){var s=Strack.build_filter({project_id:["eq",t],sequenceid:["eq",a],type:70,active:["eq",1]},{},{},{},"and",{},{},[{sortName:"created",sortOrder:"desc"}]);Strack.G.Gfilter_data.shots=s,$("#proj_table_column").datagrid({url:ProjPHP.SeqShotsList,fitColumns:!1,height:Strack.panel_height(".pseq_shots",0),rowheight:49,differhigh:!1,singleSelect:!1,adaptive:{dom:".pseq_shots",min_width:510,exth:0,domresize:1},DragSelect:!0,DataNull:Strack.DataNullTip(7030),queryParams:{filter:JSON.stringify(s)},frozenColumns:[[{field:"task_id",title:StrackPHP.Taskid,checkbox:!0}]],columns:[i],toolbar:"#task_tb",pagination:!0,pageSize:40,pageList:[40,80],pageNumber:1,pagePosition:"bottom",remoteSort:!1,onDblClickRow:function(a,i){Strack.SideColumnOpen(i.item_id,e,20,t,"proj_table_column")},onRowContextMenu:function(e,t,a){Strack.grid_clipboard(e.target),e.preventDefault(),$("#st_menu_item").menu("show",{left:e.pageX,top:e.pageY})}})}function m(e,t,a){$("#seq_history").datagrid({url:ProjPHP.SeqHistory,height:Strack.panel_height(".pseq_history",0),differhigh:!1,singleSelect:!0,fitColumns:!0,striped:!0,adaptive:{dom:".pseq_history",min_width:510,exth:0},DataNull:StrackPHP.DataNoHis,queryParams:{op_type:e,pid:a,seq_id:t,tab:"history",log_type:50},frozenColumns:[[{field:"log_id",checkbox:!0}]],columns:[[{field:"operate",title:StrackPHP.Operate,align:"center",width:120,frozen:"frozen",findex:0},{field:"projname",title:StrackPHP.Project,align:"center",width:180,frozen:"frozen",findex:1},{field:"summary",title:StrackPHP.EventLog_Summary,align:"center",width:450,frozen:"frozen",findex:2},{field:"log_val",title:StrackPHP.TMeta,align:"center",width:650,frozen:"frozen",findex:3},{field:"log_link",title:StrackPHP.EventLog_Link_Id,align:"center",width:80,frozen:"frozen",findex:4},{field:"log_type",title:StrackPHP.EventLog_Type,align:"center",width:120,frozen:"frozen",findex:5},{field:"user_id",title:StrackPHP.User,align:"center",width:160,frozen:"frozen",findex:6},{field:"created",title:StrackPHP.Created,align:"center",width:180,frozen:"frozen",findex:7}]],pagination:!0,pageSize:40,pageList:[40,80],pageNumber:1,pagePosition:"bottom",remoteSort:!1})}function _(){var e,t,a=$(".seq-left-wrap"),i=$(".proj-seq-left"),s=$(".items-ctop-title"),c=$(".proj-seq-right");$("#myhome_handle").on("mousedown",function(o){o.preventDefault(),e=680,$(document).on("mousemove",function(o){t=o.pageX<140?7:o.pageX>=e?e:o.pageX,t<140?a.hide():a.show(),s.css("width",t-200),i.css("width",t),c.css("width","calc(100% - "+t+"px)")}).on("mouseup",function(e){$(this).off("mousemove")})})}function h(){$(".item-breadcrumb-left").empty(),$(".item-breadcrumb-right").empty(),$("#item_thumb").empty(),$("#seq_d_name").empty(),$("#seq_d_fields").empty(),$(".seq-right-wrap").hide(),$("#noseq_selected").removeClass("seq_selected").show()}function f(e){var t=[];"yes"==b.batch_update.allow&&t.push({name:"sedit",text:StrackPHP.Edit_Selected,iconCls:"icon-uniF044",type:"function",click:"obj.BathEditSeqs(this)",attr_data:{grid:"data_seqs",page:"sequences"}}),"yes"==b.import_excel.allow&&t.push({name:"simport_excel",text:StrackPHP.Import_ExcelT,iconCls:"icon-uniE986",type:"function",click:"Strack.import_excel_data(this)",attr_data:{pid:e,type:60,done:"sequences",grid:"data_seqs"}}),"yes"==b.export_excel.allow&&t.push({name:"sexcel",text:StrackPHP.Export_Excel,iconCls:"icon-uniE6082",type:"function",click:"Strack.ExportExcel(this)",attr_data:{pid:e,type:60,done:"sequences",mode:"grid"}}),"yes"==b.sequence_action.allow&&t.push({name:"saction",text:StrackPHP.Action,iconCls:"icon-uniE6BB",type:"function",click:"Strack.ClientActionBatch(this)",attr_data:{type:60,grid:"data_seqs",field:"sequenceid"}}),t.push({name:"sreset",text:StrackPHP.Reset,iconCls:"icon-uniE682",type:"function",click:"Strack.ResetDatagrid(this)",attr_data:{type:6020,pid:e,grid:"data_seqs"}}),"yes"==b.sequence_del.allow&&t.push({name:"tdelete",text:StrackPHP.DeleteSelect,iconCls:"icon-uniE9D5",type:"function",click:"obj.EpistoTrash(this)",attr_data:{tab:"list"}}),t.push({name:"scopy_cell",text:StrackPHP.Copy_Grip_Cell,iconCls:"icon-uniE943",type:"function",click:"Strack.copy_clipboard(this)",attr_data:{"clipboard-action":"copy","clipboard-target":"#grid_clipboard"}}),Strack.InitMenuItem("st_menu_sequences",t),new Clipboard("#st_menu_scopy_cell")}function S(e){var t=[];"yes"==b.batch_update.allow&&t.push({name:"iedit",text:StrackPHP.Edit_Selected,iconCls:"icon-uniF044",type:"function",click:"obj.BathEditShots(this)",attr_data:{pid:e,type:70,mode:"shots",grid:"proj_table_column"}}),"yes"==b.export_excel.allow&&t.push({name:"iexcel",text:StrackPHP.Export_Excel,iconCls:"icon-uniE6082",type:"function",click:"Strack.ExportExcel(this)",attr_data:{pid:e,type:7010,done:"shots",mode:"grid"}}),"yes"==b.shots_action.allow&&t.push({name:"iaction",text:StrackPHP.Action,iconCls:"icon-uniE6BB",type:"function",click:"Strack.ClientActionBatch(this)",attr_data:{type:70,grid:"proj_table_column",field:"item_id"}}),t.push({name:"ireset",text:StrackPHP.Reset,iconCls:"icon-uniE682",type:"function",click:"Strack.ResetDatagrid(this)",attr_data:{type:7030,pid:e,grid:"proj_table_column"}}),"yes"==b.shots_del.allow&&t.push({name:"idelete",text:StrackPHP.DeleteSelect,iconCls:"icon-uniE9D5",type:"function",click:"obj.ItemstoTrash(this)",attr_data:{grid:"proj_table_column"}}),t.push({name:"icopy_cell",text:StrackPHP.Copy_Grip_Cell,iconCls:"icon-uniE943",type:"function",click:"Strack.copy_clipboard(this)",attr_data:{"clipboard-action":"copy","clipboard-target":"#grid_clipboard"}}),Strack.InitMenuItem("st_menu_item",t),new Clipboard("#st_menu_icopy_cell")}function k(t,a,i){switch($("#m_tab_"+t).find("a").each(function(){$(this).data("tab")==t&&$(this).addClass("active-list")}),$(".proj-seq-wrap").removeClass("seqs-active"),$("#table_"+t).addClass("seqs-active"),Strack.SideColumnClose(),t){case"column":e(a,i),$("#noseq_selected").show().removeClass("seq_selected"),$(".seq-right-wrap").hide(),Strack.SortDown(a,6010,"leftlist",{SortChange:"obj.sort_change",SortAdv:"obj.DataSortAdv",SortItem:"obj.DataSortItem"}),h();break;case"list":Strack.LoadFieldsList(6020,a,"data_seqs",PARSE_VAR.rules.custom_fields.allow),Strack.getViewSet(a,6020,"data_seqs",PARSE_VAR.rules,""),Strack.GroupDown(a,6020,"data_seqs",{SortChange:"Strack.sort_change",SortAdv:"Strack.DataSortAdv",SortItem:"Strack.DataSortItem"}),f(a),o(a,6020)}}function g(e,t){var a="";return a+='<div id="thumb_show_'+e+"_"+t+'" class="task-thumb-show"></div>'}function P(e){var t=$("#current_sid").val();switch($(".mitem-wrap").removeClass("active").each(function(){$(this).data("tab")==e&&$(this).addClass("active")}),e){case"shots":S(q),u(q,7030,t),Strack.getViewSet(q,7030,"proj_table_column",PARSE_VAR.rules,"");break;case"info":Strack.AjaxMfields(y,t,q,StrackPHP.DomSMfields,"sequences",60,"seq_info_list");break;case"history":m(y,t,q)}}obj={show_list:function(e){var t=$(e).data("tab");if($(".p-wrap-filter").length>0)switch(t){case"list":Strack.DoFilterClose(7030,$("#proj_table_column"));break;case"column":Strack.DoFilterClose(6020,$("#data_seqs"))}$(".tab_item").removeClass("active"),$(".menu-tab").removeClass("active-list"),Strack.save_storage("Datagrid_Seq",t),k(t,q,y)},ToggleGroup:function(e){var t=$(e).next(".sleft-gitem");t.hasClass("group-fold")?(t.show().removeClass("group-fold"),$(e).find("i").removeClass("icon-uniF107").addClass("icon-uniF106")):(t.hide().addClass("group-fold"),$(e).find("i").removeClass("icon-uniF106").addClass("icon-uniF107"))},ShowItem:function(e){var t=$(e).data("seqid"),a=$("#noseq_selected");Strack.SideColumnClose(),$(".list-item-main").removeClass("sleft-items-active"),$(e).addClass("sleft-items-active"),r(q,t,y),$("#current_sid").val(t),$("#new_shots").attr("data-seqid",t),a.hasClass("seq_selected")?$(".tab_item").removeClass("active"):(a.hide().addClass("seq_selected"),$(".seq-right-wrap").show()),$("#tab_shots").addClass("active"),$("#thumb_swrap").find(".task-thumb-show").remove(),$("#thumb_swrap").append(g(60,t)),P("shots"),Strack.LoadFieldsList(7030,q,"proj_table_column",PARSE_VAR.rules.custom_fields.allow),Strack.GroupDown(q,7030,"proj_table_column",{SortChange:"Strack.sort_change",SortAdv:"Strack.DataSortAdv",SortItem:"Strack.DataSortItem"})},SwitchTabs:function(e){var t=$(e).data("tab");$(".tab_item").removeClass("active"),$(e).addClass("active"),P(t)},sort_change:function(e){if($(e).hasClass("field-disable")&&C){var a,i,s=$(e).data("sort"),c=$(e).data("ptype");switch(C.sort[0].sortOrder=s,w=!1,t(C,q,y,1,"All","group"),s){case"asc":a="asc",i="desc";break;case"desc":a="desc",i="asc"}$("#"+a+"_sort_"+c).removeClass("field-disable").find("i").removeClass("icon-unchecked").addClass("icon-checked"),$("#"+i+"_sort_"+c).addClass("field-disable").find("i").removeClass("icon-checked").addClass("icon-unchecked"),h()}},DataSortItem:function(e){var a=($(e).data("grid"),$(e).data("ptype")),i=$(e).data("pid"),s=$(e).data("field");C=Strack.build_filter({project_id:["eq",i],active:["eq",1]},{},{},{},"and",{},{},[{sortName:s,sortOrder:"asc"}]),w=!1,t(C,i,y,1,"All","group"),$("#edit_sort_"+a).find(".sort_fields").each(function(){$(this).data("field")==s?$(this).find("i").removeClass("icon-unchecked").addClass("icon-checked"):$(this).find("i").removeClass("icon-checked").addClass("icon-unchecked")}),$("#asc_sort_"+a).removeClass("field-disable").find("i").removeClass("icon-unchecked").addClass("icon-checked"),$("#desc_sort_"+a).addClass("field-disable").find("i").removeClass("icon-checked").addClass("icon-unchecked"),h()},FilterAction:function(e){var a=$(e).data("pid"),i=$(e).data("filter"),s=($(e).data("grid"),$("#search_val_"+i).val());C=Strack.build_filter({project_id:["eq",a],active:["eq",1]},{seq_name:["LIKE","%"+s+"%"]}),w=!0,t(C,a,y,1,100,"new")},Modify_Thumb:function(){var e=$("#current_sid").val();Strack.change_item_thumb(y,e,q,"seqlist")},SeqsReset:function(e){var t=$(e).data("type"),a=$(e).data("grid"),i=$(e).data("pid");obj.DoSeqsReset(i,t,a)},DoSeqsReset:function(e,a,i){C=Strack.build_filter({project_id:["eq",e],active:["eq",1]},{},{},{},"and",{},{},[{sortName:"created",sortOrder:"desc"}]),w=!0,$("#lseq_list").off("scroll"),t(C,e,a,1,100,"new"),Strack.SortDown(e,6010,"leftlist",{SortChange:"obj.sort_change",SortAdv:"obj.DataSortAdv",SortItem:"obj.DataSortItem"}),h()},BathEditSeqs:function(e){var t=$(e).data("grid"),a=Strack.GetTaskDatagrid(t,"sequenceid",!1);switch(a.verify){case-3:layer.msg(StrackPHP.Please_Select_One,{icon:2,time:1200,anim:6});break;case 200:Strack.BatchUpDialog("#"+t,ProjPHP.TUpdateEditEeqs,a.ids.join(","),{type:"sequences",pid:q,custom:"yes",etype:6020,upmod:"sequences",multi:"no"},StrackPHP.EditFields,a)}},SeqstoTrash:function(e){var t,a=$(e).data("tab"),i=0;switch(a){case"column":var s=$("#lseq_list").find(".sleft-items-active");i=s.length,t=s.data("seqid");break;case"list":var c=$("#data_seqs").datagrid("getSelections"),o=[];c.forEach(function(e){o.push(e.sequenceid)}),i=c.length,t=o.join(",")}i>0?obj.DeleteSeqs(t,a):layer.msg(StrackPHP.Please_Select_One,{icon:2,time:1200,anim:6})},DeleteSeqs:function(e,a){$.messager.confirm(StrackPHP.Confirmation_Box,ProjPHP.DeSeqs_notice,function(i){i&&$.ajax({type:"POST",url:ProjPHP.DeleteSeqs,dataType:"json",data:{seq_ids:e,pid:q},beforeSend:function(){$.messager.progress({title:StrackPHP.Waiting,msg:StrackPHP.loading})},success:function(e){switch(Strack.top_message({bg:"g",msg:ProjPHP.DeSequencesSC}),a){case"column":w=!0,t(Strack.G.Gfilter_list.sequences,q,y,1,100,"new"),h();break;case"list":$("#data_seqs").datagrid("reload")}$.messager.progress("close")}})})},BathEditShots:function(e){var t=$(e).data("grid"),a=Strack.GetTaskDatagrid(t,"item_id",!1);switch(a.verify){case-3:layer.msg(StrackPHP.Please_Select_One,{icon:2,time:1200,anim:6});break;case 200:Strack.BatchUpDialog("#"+t,ProjPHP.TUpdateEditShots,a.ids.join(","),{type:"items",pid:q,custom:"yes",etype:7010,upmod:"shotdetails",multi:"no"},StrackPHP.EditFields,a)}},ItemstoTrash:function(e){var t=$("#proj_table_column").datagrid("getSelections"),a=[];t.forEach(function(e){a.push(e.item_id)}),Strack.ajax_grid_delete(t,StrackPHP.DeShots_notice,StrackPHP.DeleteItems,{item_ids:a.join(","),pid:q},"#proj_table_column",StrackPHP.DeShotsSC)}};var v=$("#seq_main");if(PARSE_VAR.auth.authority){var b={};!function(e){for(var t in e){var a=e[t];switch(b[a.alias]=a,a.alias){case"batch_update":case"import_excel":case"export_excel":case"sequence_add":case"sequence_del":case"shots_add":case"shots_del":"no"==a.allow&&$(".ah_"+a.alias).remove()}}}(PARSE_VAR.rules),v.show();var q=$("input[name=proj_id]").val(),y=$("input[name=p_type]").val(),C=null,w=!0,j=1,D=100;if(Strack.verify_project_data(q)>0){Strack.save_storage("projid",[q,y]),Strack.project_sub_menu(q,y);var H=Strack.read_storage("Datagrid_Seq");H||(H="column"),k(H,q,y);var x=[];x["seq_name-1"]=StrackPHP.SeqName_Length,x["seq_status-1"]=StrackPHP.SeqName_Status_Null}else $(".projpage-main").empty().append(Strack.ProjWarn(StrackPHP.Project_None_Warning))}else v.empty().append(Strack.ProjWarn(StrackPHP.NoPermission)).show()});