$(function(){function t(t,e){h="filter",l.transport.load.params={filter:JSON.stringify(Strack.G.GanttFilter)},l.load({tasks:{page:t,pageSize:e}})}function e(t){var e,a;switch(t?(a=t,Strack.save_storage("ganttReportShow",a)):(a=Strack.read_storage("ganttReportShow"),a=a||"isReport"),a){case"isReport":e=20;break;case"noReport":e=10}return Strack.G.GanttFilter=Strack.build_filter({project_id:["eq",d],active:["eq",1],isreport:["eq",e]},{},{},{},{},{},[{sortName:"type",sortOrder:"asc"}]),Strack.G.GanttFilter}function a(t,e,a,n){$("#gantt_page").pagination({total:e,pageNumber:a,pageSize:n,pageList:[100,200],onSelectPage:function(t,e){l.load({tasks:{page:t,pageSize:e}})}})}function n(t,e){$("#gantt_page").pagination("refresh",{total:t,pageNumber:e})}function r(){var t=$("#gantt_list");o.setSize(t.width(),t.height())}function i(){l.sync(function(){l.commit()})}obj={ResetGanttData:function(){Strack.G.GanttFilter.request={project_id:["eq",d],active:["eq",1],isreport:["eq",20]},Strack.G.GanttFilter.filter_bar=[],t(1,100)},TaskstoTrash:function(){},saveGantt:function(){i()},switchScale:function(t){switch($(t).data("scale")){case"week":c.switchViewPreset("weekAndDayLetter");break;case"month":c.switchViewPreset("monthAndYear");break;case"year":c.switchViewPreset("year",new Date(c.getStart().getFullYear(),1,1),new Date(c.getStart().getFullYear()+5,1,1))}},ScalePlus:function(){c.zoomIn()},ScaleMinus:function(){c.zoomOut()},timelineBack:function(){c.shiftPrevious()},timelineForward:function(){c.shiftNext()},jumpToToday:function(){c.goToNow()},Expand_All:function(){parseInt(p)<50?c.Expand_All():layer.msg(GanttPHP.Gantt_Total_Limit,{icon:2,time:1200,anim:6})},cloesAll:function(){parseInt(p)<50?c.collapseAll():layer.msg(GanttPHP.Gantt_Total_Limit,{icon:2,time:1200,anim:6})},switchEntity:function(e){var a=$(e).data("entity"),n=0;switch(a){case"preproduction":n=30;break;case"asset":n=40;break;case"shot":n=70}Strack.G.GanttFilter.request.type=n,t(1,100)},FilterGantt:function(e){Strack.G.GanttFilter=e,t(1,100)}};var s=$("#tac_project");if(PARSE_VAR.auth.authority){var o,c,l,d=$("input[name=proj_id]").val(),u=Strack.verify_project_data(d),h="new",p=0;if(u>0){var m,g,k;!function(t){for(var e in t){var a=t[e];switch(a.alias){case"edit_gantt_task":"no"==a.allow&&$(".ah_"+a.alias).remove()}}}(PARSE_VAR.rules),"yes"==PARSE_VAR.rules.edit_gantt_task.allow?(m=!0,g="both",k=!0):(m=!1,g="none",k=!1);Strack.project_sub_menu(d,80),function(){$("#datalist_main_8010").on("mresize",function(){r()})}(),function(t,r){l=Ext.create("Gnt.data.CrudManager",{autoLoad:!0,autoDestroy:!0,taskStore:Ext.create("Gnt.data.TaskStore",{page:t,pageSize:r,test:"test"}),transport:{load:{method:"POST",type:"JSON",paramName:"request",params:{filter:JSON.stringify(e())},url:GanttPHP.GanttDataTask},sync:{method:"POST",type:"JSON",paramName:"request",params:{pid:d},url:GanttPHP.syncGanttTask}},listeners:{beforesend:function(){},requestdone:function(e,i,s){switch(p=s.tasks.total,h){case"new":a(d,p,t,r),h="more";break;case"filter":n(p,t),h="more"}}}}),Ext.apply(Ext.util.Format,{statusRenderer:function(t){return t?Strack.widget_status_dom(t.status_icon,t.status_name,t.status_color):""},thumbRenderer:function(t){switch(t.render){case"task":return'<div class="gantt_tree_content">'+Strack.NolazyTaskThumb(StrackPHP.TASK_THUMB,StrackPHP.pagetask,t.folder,t.thumb,t.task_id,t.project_id,t.type,"min")+"</div>";case"item":return t.number}}}),c=Ext.create("Gnt.panel.Gantt",{flex:1,viewPreset:"weekAndDayLetter",weekendsAreWorkdays:!0,startDate:new Date(Strack.lastMFirst("today")),endDate:Sch.util.Date.add(new Date,Sch.util.Date.WEEK,4),leftLabelField:"itemName",showTodayLine:!0,highlightWeekends:!0,columnLines:!0,cascadeChanges:!0,lockedGridConfig:{flex:.5},enableDependencyDragDrop:m,enableDragCreation:m,enableProgressBarResize:m,enableTaskDragDrop:m,enableTaskReordering:m,resizeHandles:g,tipCfg:{cls:"tasktip"},tooltipTpl:new Ext.XTemplate("<table>",'<tr><th class="caption" colspan="2">#{id} {itemName}</th></tr>',"<tr>",'<th>Start:</th><td>{[values._record.getDisplayStartDate("y-m-d")]}</td>',"</tr>","<tr>",'<th>End:</th><td>{[values._record.getDisplayEndDate("y-m-d")]}</td>',"</tr>","</table>"),columns:[{text:StrackPHP.Type,xtype:"namecolumn",tdCls:"namecell",width:60},{header:StrackPHP.Thumbnail,width:78,dataIndex:"thumb",formatter:"thumbRenderer"},{header:StrackPHP.Name,width:160,dataIndex:"itemName"},{header:StrackPHP.StartTime,xtype:"startdatecolumn",format:"Y-m-d"},{header:StrackPHP.EndTime,xtype:"enddatecolumn",format:"Y-m-d"},{header:StrackPHP.Duration,xtype:"durationcolumn"},{header:StrackPHP.Status,width:160,dataIndex:"status",formatter:"statusRenderer"},{header:StrackPHP.Steps,width:90,dataIndex:"step"},{header:StrackPHP.Current_Version,width:160,dataIndex:"version"},{header:StrackPHP.Assignee,width:120,dataIndex:"assignee"}],listeners:{beforeedit:function(t,e){return k},cellclick:function(t,e,a,n,r,i,s){n.data.StartDate&&!$(e).hasClass("sch-timetd")&&c.scrollToDate(n.data.StartDate)},afterdragcreate:function(t,e){i()},aftertaskdrop:function(t,e,a){i()},aftertaskresize:function(t,e,a){i()}},crudManager:l,plugins:["scheduler_treecellediting"]});var s=$("#gantt_list");o=Ext.create("Ext.panel.Panel",{renderTo:"gantt_list",width:s.width(),height:s.height(),border:!1,layout:{type:"border",padding:"0"},items:[{region:"center",padding:"0",layout:"fit",items:c}]})}(1,100)}else s.empty().append(Strack.ProjWarn(StrackPHP.Project_None_Warning)).show()}else s.empty().append(Strack.ProjWarn(StrackPHP.NoPermission)).show()});