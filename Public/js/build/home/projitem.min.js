$(function(){function t(t,a,e,i,s){var r=Strack.build_filter({project_id:["eq",a],item_id:["eq",e],active:["eq",1]},{},{},{},"and",{},{},[{sortName:"created",sortOrder:"desc"}]);Strack.G.Gfilter_data[l(i)]=r,$("#proj_table_list").datagrid({url:EntityPHP.DataPitem,fitColumns:!1,height:Strack.panel_height(".pitem_tasklist",0),rowheight:49,differhigh:!1,singleSelect:!1,DragSelect:!0,adaptive:{dom:".pitem_tasklist",min_width:510,exth:0,domresize:1},DataNull:Strack.DataNullTip(i),queryParams:{filter:JSON.stringify(r),op_type:t,ptype:i,project_id:a,e_id:e,tab:"tasks"},frozenColumns:[[{field:"task_id",title:StrackPHP.Taskid,checkbox:!0}]],columns:[s],toolbar:"#task_tb",pagination:!0,pageSize:100,pageList:[100,200],pageNumber:1,pagePosition:"bottom",remoteSort:!1,groupField:"type_id",view:groupview,groupActive:!0,groupFormatter:function(t,a){return'<span class="">'+a[0].type_name+" - "+a.length+" "+StrackPHP.TasksUnit+"</span>"},onDblClickRow:function(e,i){Strack.SideColumnOpen(i.task_id,t,10,a,"proj_table_list")},onLoadSuccess:function(t){$("a.athumb").on("click",function(t){Strack.save_storage("task_panel_tab","activity")})},onRowContextMenu:function(t,a,e){Strack.grid_clipboard(t.target),t.preventDefault(),$("#st_menu_task").menu("show",{left:t.pageX,top:t.pageY})}}),Strack.LoadFieldsList(i,1,"proj_table_list",PARSE_VAR.rules.custom_fields.allow),Strack.GroupDown(a,i,"proj_table_list",{SortChange:"Strack.sort_change",SortAdv:"Strack.DataSortAdv",SortItem:"Strack.DataSortItem"},{group:"type_id"})}function a(a,e,i,s){$.ajax({type:"POST",url:StrackPHP.DynamicFields,dataType:"json",data:{project_id:e,type:s},success:function(r){var o=[];r.forEach(function(t,a){t&&o.push(Strack.DynamicFieldset(s,t,a,"",{pid:e}))}),t(a,e,i,s,o)}})}function e(t,a,e){$.ajax({type:"POST",url:EntityPHP.DataPitem,data:{tab:"onset",op_type:t,e_id:a},beforeSend:function(){$(".item-mainwrap").append(Strack.loading_dom("white","","onset"))},success:function(t){var i=JSON.parse(t),s=Strack.SideColumnBuildOnset(a,e,i,"onset");$(".onset-info-edit").empty().append(s),$("#st-load_onset").remove(),$(".pswp").length<1&&$("body").append(Strack.PhotoSwipeButtonDOM()),Strack.LoadOnsetAtt(e,a)}})}function i(t,a,e){var i=Strack.build_filter({project_id:["eq",t],active:["eq",1]},{},{},{},"and",{},{},[{sortName:"created",sortOrder:"desc"}]);Strack.G.Gfilter_data.linkassets=i,$("#proj_table_column").datagrid({url:EntityPHP.DataLinkAsset,fitColumns:!1,height:Strack.panel_height(".pitem_linkasset",0),rowheight:49,differhigh:!0,autocolumns:!0,gridname:"asset",adaptive:{dom:".pitem_linkasset",min_width:0,exth:0,domresize:1},DragSelect:!0,DataNull:Strack.DataNullTip(4010),queryParams:{eid:e,pid:t,pype:10,type:40,ptype:4010,filter:JSON.stringify(i),thumb:StrackPHP.ITEM_THUMB,url:StrackPHP.projitem,turl:StrackPHP.pagetask,from:"item"},toolbar:"#lasset_tb",pagination:!0,pageSize:40,pageList:[40,80],pageNumber:1,pagePosition:"bottom",remoteSort:!1,onDblClickRow:function(e,i){Strack.SideColumnOpen(i.item_id,a,20,t,"proj_table_column")},onRowContextMenu:function(t,a,e){Strack.grid_clipboard(t.target),t.preventDefault(),$("#st_menu_linkasset").menu("show",{left:t.pageX,top:t.pageY})}})}function s(t,a,e){var i=t+"20,30";$("#item_history").datagrid({url:EntityPHP.DataPitem,height:Strack.panel_height(".pitem_history",0),differhigh:!1,singleSelect:!0,striped:!0,adaptive:{dom:".pitem_history",min_width:510,exth:0},DataNull:StrackPHP.DataNoHis,queryParams:{op_type:t,pid:e,e_id:a,tab:"history",log_type:i},frozenColumns:[[{field:"log_id",checkbox:!0}]],columns:[[{field:"operate",title:StrackPHP.Operate,align:"center",width:120,frozen:"frozen",findex:0},{field:"projname",title:StrackPHP.Project,align:"center",width:180,frozen:"frozen",findex:1},{field:"summary",title:StrackPHP.EventLog_Summary,align:"center",width:450,frozen:"frozen",findex:2},{field:"log_val",title:StrackPHP.TMeta,align:"center",width:650,frozen:"frozen",findex:3},{field:"log_link",title:StrackPHP.EventLog_Link_Id,align:"center",width:80,frozen:"frozen",findex:4},{field:"log_type",title:StrackPHP.EventLog_Type,align:"center",width:120,frozen:"frozen",findex:5},{field:"user_id",title:StrackPHP.User,align:"center",width:160,frozen:"frozen",findex:6},{field:"created",title:StrackPHP.Created,align:"center",width:180,frozen:"frozen",findex:7}]],pagination:!0,pageSize:40,pageList:[40,80],pageNumber:1,pagePosition:"bottom",remoteSort:!1})}function r(t,a,e){$.ajax({type:"POST",url:EntityPHP.LoadItemImg,data:{e_id:t,project_id:a,type:20},beforeSend:function(){$(".item-thumb-warp").prepend(Strack.loading_dom("white","","thumb"))},success:function(t){var a=JSON.parse(t),i=$("#item_thumb"),s="";$("#st-load_thumb").remove(),"no"==PARSE_VAR.rules.upload_thumb.allow&&$("#item_up_thumb").empty().html(StrackPHP.Thumbnail),400==parseInt(a.status)?(s='<div class="task-thumb-null">'+Strack.ProjTaskIcon(e)+"</div>",i.empty().append(s)):(s=EntityPHP.ITEM_THUMB+"/"+a.thumb+"_max.jpg",i.empty().append('<img src="'+s+'">'))}})}function o(t,a,e){var i="";EntityPHP.projitem.replace(".html","");return i+='<div class="ui small breadcrumb">',i+='<a class="section" href="'+Strack.remove_html_ext(Strack.ProjSubUrl(t))+"/"+a+'.html" >'+Strack.ProjSubName(t)+"</a>",i+='<i class="right angle icon divider"></i>',i+='<div class="active section">'+e+"</div>",i+="</div>",i+="</div>",i+="</div>"}function c(t,a,e,i){var s="";return s+='<a class="section" href="'+Strack.remove_html_ext(Strack.ProjSubUrl(t))+"/"+a+'.html" >'+Strack.ProjSubName(t)+'</a><i class="right angle icon divider"></i><i class="'+i.status_icon+' icon-left" style="color:#'+i.status_color+'"></i><div class="active section taskm_content">'+e+"</div>"}function n(t){var a="";switch(t){case 10:a='<a href="javascript:;" id="tab_tasks" class="item tab_item"  style="margin-left:20px;" onclick="obj.SwitchTabs(this);" data-tab="tasks">'+StrackPHP.Tasks+"</a>";break;case 20:a='<a href="javascript:;" id="tab_info" class="item tab_item" onclick="obj.SwitchTabs(this);" data-tab="info">'+Strack.ProjSubName(u)+StrackPHP.Info+"</a>";break;case 30:a='<a href="javascript:;" id="tab_onset" class="item tab_item" onclick="obj.SwitchTabs(this);" data-tab="onset">'+StrackPHP.OnSet+"</a>";break;case 40:a='<a href="javascript:;" id="tab_linkasset" class="item tab_item" onclick="obj.SwitchTabs(this);" data-tab="linkasset">'+StrackPHP.Assets+"</a>";break;case 50:a='<a href="javascript:;" id="tab_history" class="item tab_item" onclick="obj.SwitchTabs(this);" data-tab="history">'+StrackPHP.History+"</a>"}return a}function l(t){var a;switch(parseInt(t)){case 3010:a="preprods";break;case 3020:a="preprod_tasks";break;case 4010:a="assets";break;case 4020:a="asset_tasks";break;case 4110:a="system";break;case 4120:a="system_tasks";break;case 4210:a="program";break;case 4220:a="program_tasks";break;case 4310:a="bug";break;case 4320:a="bug_tasks";break;case 7010:a="shots";break;case 7020:a="shot_tasks"}return a}function p(t,a){var e=[];"yes"==P.myhome_assign.allow&&e.push({name:"tassign",text:StrackPHP.Assign,iconCls:"icon-uniE99B",type:"function",click:"Strack.TasksAssign(this)",attr_data:{grid:"proj_table_list",pid:t,type:a}}),"yes"==P.myhome_copyto.allow&&e.push({name:"tcopyto",text:StrackPHP.CopyTo,iconCls:"icon-uniE629",type:"function",click:"Strack.TasksCopyTo(this)",attr_data:{grid:"proj_table_list",pid:t,type:a}}),"yes"==P.batch_update.allow&&e.push({name:"tedit",text:StrackPHP.TasksUpdate,iconCls:"icon-uniE9AB",type:"function",click:"obj.TasksUpdate(this)",attr_data:{pid:t,ftype:a+"20",mode:"tasks",grid:"proj_table_list"}}),"yes"==P.export_excel.allow&&e.push({name:"texcel",text:StrackPHP.Export_Excel,iconCls:"icon-uniE6082",type:"function",click:"Strack.ExportExcel(this)",attr_data:{pid:t,type:a+"20",done:l(a+"20"),mode:"grid"}}),"yes"!=P.pre_action.allow&&"yes"!=P.assets_action.allow&&"yes"!=P.shots_action.allow||e.push({name:"taction",text:StrackPHP.Action,iconCls:"icon-uniE6BB",type:"function",click:"Strack.ClientActionBatch(this)",attr_data:{type:20,grid:"proj_table_list",field:"task_id"}}),e.push({name:"treset",text:StrackPHP.Reset,iconCls:"icon-uniE682",type:"function",click:"Strack.ResetDatagrid(this)",attr_data:{type:a+"20",pid:t,grid:"proj_table_list"}}),"yes"==P.tasks_del.allow&&e.push({name:"tdelete",text:StrackPHP.MovetoTrash,iconCls:"icon-uniE9D5",type:"function",click:"obj.TaskstoTrash(this)",attr_data:{id:"task_id",ftype:a+"20",grid:"proj_table_list"}}),e.push({name:"tcopy_cell",text:StrackPHP.Copy_Grip_Cell,iconCls:"icon-uniE943",type:"function",click:"Strack.copy_clipboard(this)",attr_data:{"clipboard-action":"copy","clipboard-target":"#grid_clipboard"}}),Strack.InitMenuItem("st_menu_task",e),new Clipboard("#st_menu_tcopy_cell")}function d(t,a){var e=[];"yes"==P.export_excel.allow&&e.push({name:"lexcel",text:StrackPHP.Export_Excel,iconCls:"icon-uniE6082",type:"function",click:"Strack.ExportExcel(this)",attr_data:{pid:t,type:4010,done:"linkassets",eid:a,mode:"grid",from:"item"}}),"yes"==P.assets_action.allow&&e.push({name:"laction",text:StrackPHP.Action,iconCls:"icon-uniE6BB",type:"function",click:"Strack.ClientActionBatch(this)",attr_data:{type:40,grid:"proj_table_column",field:"item_id"}}),e.push({name:"treset",text:StrackPHP.Reset,iconCls:"icon-uniE682",type:"function",click:"Strack.ResetDatagrid(this)",attr_data:{type:4010,pid:t,grid:"proj_table_column"}}),"yes"==P.linkassets_del.allow&&e.push({name:"ldelete",text:EntityPHP.LinkAssetsDel,iconCls:"icon-uniE9D5",type:"function",click:"Strack.DELinkAsset(this)",attr_data:{pid:t,eid:a,type:4010,grid:"proj_table_column"}}),e.push({name:"lcopy_cell",text:StrackPHP.Copy_Grip_Cell,iconCls:"icon-uniE943",type:"function",click:"Strack.copy_clipboard(this)",attr_data:{"clipboard-action":"copy","clipboard-target":"#grid_clipboard"}}),Strack.InitMenuItem("st_menu_linkasset",e),new Clipboard("#st_menu_lcopy_cell")}function k(t){switch($(".pitem-wrap").removeClass("active").each(function(){$(this).data("tab")==t&&$(this).addClass("active")}),t){case"tasks":p(m,u),a(u,m,S,h),Strack.getViewSet(m,h,"proj_table_list",PARSE_VAR.rules,"");break;case"info":Strack.AjaxMfields(u,S,m,StrackPHP.DataPitem,"items",20,"item_info_list");break;case"onset":e(u,S,m);break;case"linkasset":d(m,S),i(m,u,S),Strack.GroupDown(m,4010,"proj_table_column",{SortChange:"Strack.sort_change",SortAdv:"Strack.DataSortAdv",SortItem:"Strack.DataSortItem"});break;case"history":s(u,S,m)}}obj={SwitchTabs:function(t){var a=$(t),e=$(t).data("tab");if($(".p-wrap-filter").length>0)switch(e){case"tasks":Strack.DoFilterClose(4010,$("#proj_table_column"));break;case"linkasset":Strack.DoFilterClose(h,$("#proj_table_list"))}$(".tab_item").removeClass("active"),a.addClass("active"),k(e),Strack.save_storage("item_panel_tab",e),Strack.SideColumnClose()},Modify_Thumb:function(t){Strack.open_dialog("dialog",{title:EntityPHP.Upload_Thumb,width:480,height:180,content:Strack.dialog_dom({type:"normal",hidden:[{case:101,id:"Mproj_id",type:"hidden",name:"proj_id",valid:1,value:m},{case:102,id:"Mproj_canvas"}],items:[{case:1,id:"Mproj_thumb",type:"text",lang:StrackPHP.Name,name:"proj_thumb",valid:0,value:""}],footer:[{obj:"choice_thumb",type:4,title:""},{obj:"up_thumb",type:1,title:StrackPHP.Update},{obj:"dialog_cancel",type:8,title:StrackPHP.Cancel}]}),inits:function(){Strack.upload_image("img_up_bnt","Mproj_thumb","Mproj_canvas")},close:function(){Strack.G.Jcrop_Canvas=null}})},up_thumb:function(){if(Strack.G.Jcrop_Canvas){var t=($("input[id=Mproj_id]").val(),Strack.G.Jcrop_Canvas.toDataURL("image/jpg"));$.ajax({type:"POST",url:EntityPHP.UPItemThumb,data:{pid:m,e_id:S,type:20,up_url:StrackPHP.UPLOADS,img:t},beforeSend:function(){$.messager.progress({title:StrackPHP.Waiting,msg:StrackPHP.loading})},success:function(t){$.messager.progress("close");var a=JSON.parse(t);-1==a.status?$.messager.alert(StrackPHP.Warning,StrackPHP.Illegal_Operation,"warning"):-400==a.status?$.messager.alert(StrackPHP.Warning,StrackPHP.Upload_Failed,"warning"):200==a.status&&($("#dialog").dialog("close"),r(S,m),Strack.top_message({bg:"g",msg:EntityPHP.Thumb_Upload_SC}))}})}else $.messager.alert(StrackPHP.Notice,EntityPHP.Please_Select_Image,"info")},TasksUpdate:function(t){var a=$(t).data("grid"),e=$(t).data("ftype"),i=Strack.GetTaskDatagrid(a,"task_id",!1);switch(i.verify){case-3:layer.msg(StrackPHP.Please_Select_One,{icon:2,time:1200,anim:6});break;case 200:var s="";switch(parseInt(e)){case 3020:s=EntityPHP.TUpdateEditProdtasks;break;case 4020:s=EntityPHP.TUpdateEditAssettasks;break;case 4120:s=EntityPHP.TUpdateEditSystemtasks;break;case 4220:s=EntityPHP.TUpdateEditProgramtasks;break;case 4320:s=EntityPHP.TUpdateEditBugtasks;break;case 7020:s=EntityPHP.TUpdateEditShottasks}Strack.BatchUpDialog("#"+a,s,i.ids.join(","),{type:"tasks",pid:m,custom:"yes",etype:e,upmod:l(e),multi:"no"},StrackPHP.EditFields,i)}},TaskstoTrash:function(t){var a,e,i=$("#proj_table_list").datagrid("getSelections"),s=[],r=$(t).data("ftype");switch(i.forEach(function(t){s.push(t.task_id)}),parseInt(r)){case 3020:a=StrackPHP.DeProdtasks_notice,e=StrackPHP.DeProdtasksSC;break;case 4020:a=StrackPHP.DeAssettasks_notice,e=StrackPHP.DeAssettasksSC;break;case 4120:a=StrackPHP.DeSystemtasks_notice,e=StrackPHP.DeSystemtasksSC;break;case 4220:a=StrackPHP.DeProgramtasks_notice,e=StrackPHP.DeProgramtasksSC;break;case 4320:a=StrackPHP.DeBugtasks_notice,e=StrackPHP.DeBugtasksSC;break;case 7020:a=StrackPHP.DeShottasks_notice,e=StrackPHP.DeShottasksSC}Strack.ajax_grid_delete(i,a,StrackPHP.DeleteTasks,{task_ids:s.join(","),pid:m,ptype:r},"#proj_table_list",e)}};var _=$(".projpage-main");if(PARSE_VAR.auth.authority){var m=$("input[name=proj_id]").val(),u=$("input[name=p_ty]").val(),S=$("input[name=item_id]").val(),P={},h=parseInt(u+"20");if(1===parseInt(PARSE_VAR.validate)){_.show(),function(t){for(var a in t){var e=t[a];switch(P[e.alias]=e,e.alias){case"batch_update":case"top_fields_edit":case"export_excel":case"tasks_add":case"tasks_del":case"myhome_assign":case"myhome_copyto":case"main_fields_edit":case"onset_att":case"linkassets_add":case"linkassets_del":"no"==e.allow&&$(".ah_"+e.alias).remove();break;case"shots_action":"no"==e.allow&&70==parseInt(u)&&$(".ah_shots_action").remove();break;case"pre_action":"no"==e.allow&&30==parseInt(u)&&$(".ah_pre_action").remove();break;case"assets_action":"no"==e.allow&&40==parseInt(u)&&$(".ah_assets_action").remove()}}}(PARSE_VAR.rules),$("#excel_out").attr("data-done",l(h)),Strack.save_storage("projid",[m,u]),Strack.project_sub_menu(m,u),function(t){var a,e="";switch(parseInt(t)){case 30:a=[10,20,40,50];break;case 40:case 41:case 42:case 43:a=[10,20,50];break;case 70:a=[10,20,30,40,50]}a.forEach(function(t){e+=n(t)}),$("#item_tabs").empty().append(e)}(u),Strack.AjaxHfields(u,S,m,StrackPHP.DomEHfields,"items",20),r(S,m,u),$(".special.cards .image").dimmer({on:"hover"}),function(t,a,e){$.ajax({type:"POST",url:EntityPHP.LoadItemBase,data:{e_id:t,project_id:a,op_type:e},success:function(t){var a=JSON.parse(t),e="";e+=Strack.ProjTaskIcon(a.type),e+='<span class="taskm_content">'+a.entity+"</span>",$(".item-mid-name").empty().append(e);var i=o(a.type,a.project_id,a.entity);$(".item-breadcrumb-left").empty().append(i)}})}(S,m,u);var b=function(t,a){var e;switch(parseInt(t)){case 30:e=["tasks","info","linkasset","history"];break;case 40:case 41:case 42:case 43:e=["tasks","info","history"];break;case 70:e=["tasks","info","onset","linkasset","history"]}return $.inArray(a,e)>=0?a:"tasks"}(u,Strack.read_storage("item_panel_tab"));$("#tab_"+b).addClass("active"),k(b),function(t,a,e){var i=$("#task_hidebar");$(".projpage-main").on("scroll",function(){this.scrollTop||this.scrollTop,this.scrollHeight||this.scrollHeight,this.clientHeight||this.clientHeight,$("#projitem_footer").offset().top<80?i.hasClass("active")?i.show(200):(i.show(200).addClass("active"),$.ajax({type:"POST",url:EntityPHP.LoadHideBar,data:{e_id:t,project_id:a,type:20},success:function(t){var i=JSON.parse(t),s=$("#hidebar_thumb"),r="";i.thumb?(r=EntityPHP.ITEM_THUMB+"/"+i.thumb+"_min.jpg",s.empty().append('<img src="'+r+'">')):(r='<div class="task-thumb-null">'+Strack.ProjTaskIcon(e)+"</div>",s.empty().append(r)),$("#hidebar_bread").empty().append(c(e,a,i.item_name,i.status_info))}})):i.hide(200).removeClass("active")})}(S,m,u)}else _.empty().append(Strack.ProjWarn(StrackPHP.Entity_None_Warning)).show()}else _.empty().append(Strack.ProjWarn(StrackPHP.NoPermission)).show()});