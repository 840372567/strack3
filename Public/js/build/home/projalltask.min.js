$(function(){function t(t,a,e){var i=Strack.build_filter({project_id:["eq",a],active:["eq",1]},{},{},{},"and",{},{},[{sortName:"created",sortOrder:"desc"}]);Strack.G.Gfilter_data.alltasks=i,$("#datagrid_box").datagrid({url:StrackPHP.DataPitem,fitColumns:!1,height:Strack.panel_height(".entity-datalist",0),rowheight:49,differhigh:!1,singleSelect:!1,DragSelect:!0,adaptive:{dom:".entity-datalist",min_width:510,exth:0,domresize:1},queryParams:{filter:JSON.stringify(i),op_type:t,ptype:8020,project_id:a,tab:"tasks"},frozenColumns:[[{field:"task_id",title:StrackPHP.Taskid,checkbox:!0}]],columns:[e],toolbar:"#task_tb",pagination:!0,pageSize:100,pageList:[100,200],pageNumber:1,pagePosition:"bottom",remoteSort:!1,onDblClickRow:function(t,e){Strack.SideColumnOpen(e.task_id,e.type,10,a,"datagrid_box")},onRowContextMenu:function(t,a,e){Strack.grid_clipboard(t.target),t.preventDefault(),$("#st_menu_task").menu("show",{left:t.pageX,top:t.pageY})}}),Strack.LoadFieldsList(8020,1,"datagrid_box","no"),Strack.GroupDown(a,8020,"datagrid_box",{SortChange:"Strack.sort_change",SortAdv:"Strack.DataSortAdv",SortItem:"Strack.DataSortItem"},{group:"type_id"}),Strack.getViewSet(a,8020,"datagrid_box",PARSE_VAR.rules,"")}obj={addDefaultTask:function(t){var a={type:"tasks",pid:e,custom:"yes",multi:"no",etype:8020,upmod:"newDefaultTasks"},i=$(t).data("grid");Strack.open_dialog("dialog",{title:StrackPHP.Add_Task,width:560,height:360,content:Strack.dialog_dom({type:1,hidden:[{case:101,id:"Mtype",type:"hidden",name:"type",valid:1,value:a.etype},{case:101,id:"Mproject_id",type:"hidden",name:"project_id",valid:1,value:e}],items:[{case:1,id:"Mup_fields",type:"text",lang:StrackPHP.Fields,name:"fields",valid:1,value:""}],update:!0,footer:[{obj:"AddNewTask",type:1,title:StrackPHP.Update},{obj:"dialog_cancel",type:8,title:StrackPHP.Cancel},{obj:"save_dialog_setting",type:8,title:StrackPHP.Save_Setting}]}),inits:function(){var t,i=[7726,7738,7700,7733,7716,7720],n=Strack.G.DialogAddSetting[a.etype];t=n&&200==parseInt(n.status)?n.optionValue:i,$("#Mup_fields").combobox({url:StrackPHP.EditFields,width:350,valueField:"id",textField:"lang",multiple:!0,value:"",queryParams:a,onSelect:function(t){if(0==$("#dgup_i_"+t.id).length){var i=Strack.BatchUpItem(t,"new");$("#st_dgup").append(i.item_dom),Strack.BatchItemInit(t,e,8020,i.id,a.type,t)}},onUnselect:function(t){$.inArray(t.id,i)<0?$("#dgup_i_"+t.id).remove():($(this).combobox("select",t.id),layer.msg(StrackPHP.Must_Field,{icon:2,time:1200,anim:6}))},onLoadSuccess:function(){var a=$(this);t.forEach(function(t){a.combobox("select",t)})}})},close:function(){$("#"+i).datagrid("reload")}})},AddNewTask:function(){var t=$("#Mproject_id").val();Strack.doBatchUpdate("new",t,8020,"newDefaultTasks",!0)},TasksUpdate:function(t){var a=$(t).data("grid"),e=Strack.GetTaskDatagrid(a,"task_id",!0);switch(e.verify){case-1:layer.msg(StrackPHP.E_MULTI_PROJECT,{icon:2,time:1200,anim:6});break;case-2:layer.msg(StrackPHP.E_MULTI_ENTITY,{icon:2,time:1200,anim:6});break;case-3:layer.msg(StrackPHP.Please_Select_One,{icon:2,time:1200,anim:6});break;case 200:Strack.BatchUpDialog("#"+a,StrackPHP.TasksUpdate,e.ids.join(","),{type:"tasks",pid:0,custom:"no",etype:1020,upmod:"myhome",multi:"yes"},StrackPHP.EditFields,e)}},TaskstoTrash:function(t){var a=$("#datagrid_box").datagrid("getSelections"),i=[],n=$(t).data("ftype");a.forEach(function(t){i.push(t.task_id)});var o=StrackPHP.DeAll_Tasks_notice,s=StrackPHP.DeAll_TasksSC;Strack.ajax_grid_delete(a,o,StrackPHP.DeleteTasks,{task_ids:i.join(","),pid:e,ptype:n},"#datagrid_box",s)}};var a=$(".projpage-main");if(PARSE_VAR.auth.authority){var e=$("input[name=proj_id]").val(),i=Strack.verify_project_data(e),n={};i>0?(a.show(),function(t){for(var a in t){var e=t[a];switch(n[e.alias]=e,e.alias){case"batch_update":case"top_fields_edit":case"export_excel":case"tasks_add":case"tasks_del":case"myhome_assign":case"myhome_copyto":case"main_fields_edit":case"onset_att":case"linkassets_add":case"linkassets_del":"no"==e.allow&&$(".ah_"+e.alias).remove();break;case"shots_action":"no"==e.allow&&70==parseInt(type)&&$(".ah_shots_action").remove();break;case"pre_action":"no"==e.allow&&30==parseInt(type)&&$(".ah_pre_action").remove();break;case"assets_action":"no"==e.allow&&40==parseInt(type)&&$(".ah_assets_action").remove()}}}(PARSE_VAR.rules),Strack.project_sub_menu(e,81),function(t,a,e){var i=[];"yes"==n.myhome_assign.allow&&i.push({name:"tassign",text:StrackPHP.Assign,iconCls:"icon-uniE99B",type:"function",click:"Strack.TasksAssign(this)",attr_data:{grid:"datagrid_box",pid:t,type:a}}),"yes"==n.myhome_copyto.allow&&i.push({name:"tcopyto",text:StrackPHP.CopyTo,iconCls:"icon-uniE629",type:"function",click:"Strack.TasksCopyTo(this)",attr_data:{grid:"datagrid_box"}}),"yes"==n.batch_update.allow&&i.push({name:"tedit",text:StrackPHP.TasksUpdate,iconCls:"icon-uniE9AB",type:"function",click:"obj.TasksUpdate(this)",attr_data:{pid:t,ftype:e,mode:"alltask",grid:"datagrid_box"}}),i.push({name:"ttoay",text:StrackPHP.Today,iconCls:"icon-uniF06A",type:"function",click:"Strack.EntityTodayTask(this)",attr_data:{type:e,pid:t,grid:"datagrid_box",done:"tasks"}}),i.push({name:"tdaily",text:StrackPHP.Daily,iconCls:"icon-uniE60B",type:"function",click:"Strack.EntityDailyTask(this)",attr_data:{type:e,pid:t,grid:"datagrid_box",done:"tasks"}}),"yes"==n.export_excel.allow&&i.push({name:"texcel",text:StrackPHP.Export_Excel,iconCls:"icon-uniE6082",type:"function",click:"Strack.ExportExcel(this)",attr_data:{pid:t,type:e,done:"alltasks",mode:"grid"}}),"yes"==n.task_action.allow&&i.push({name:"taction",text:StrackPHP.Action,iconCls:"icon-uniE6BB",type:"function",click:"Strack.ClientActionBatch(this)",attr_data:{type:20,grid:"datagrid_box",field:"task_id"}}),i.push({name:"treset",text:StrackPHP.Reset,iconCls:"icon-uniE682",type:"function",click:"Strack.ResetDatagrid(this)",attr_data:{type:e,pid:t,grid:"datagrid_box"}}),"yes"==n.tasks_del.allow&&i.push({name:"tdelete",text:StrackPHP.MovetoTrash,iconCls:"icon-uniE9D5",type:"function",click:"obj.TaskstoTrash(this)",attr_data:{id:"task_id",ftype:"alltask",grid:"datagrid_box"}}),i.push({name:"tcopy_cell",text:StrackPHP.Copy_Grip_Cell,iconCls:"icon-uniE943",type:"function",click:"Strack.copy_clipboard(this)",attr_data:{"clipboard-action":"copy","clipboard-target":"#grid_clipboard"}}),Strack.InitMenuItem("st_menu_task",i),new Clipboard("#st_menu_tcopy_cell")}(e,81,8020),function(a,e,i){$.ajax({type:"POST",url:StrackPHP.DynamicFields,dataType:"json",data:{project_id:e,type:i},success:function(n){var o=[];n.forEach(function(t,a){t&&o.push(Strack.DynamicFieldset(i,t,a,"",{pid:e}))}),t(a,e,o)}})}(81,e,8020)):a.empty().append(Strack.ProjWarn(StrackPHP.Project_None_Warning)).show()}else a.empty().append(Strack.ProjWarn(StrackPHP.NoPermission)).show()});