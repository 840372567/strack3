$(function(){obj={switch_tab:function(e){t($(e).data("tab"))},member_add:function(e){var t=$(e).data("lang");Strack.item_operate_dialog(t,{mode:"create",field_list_type:["edit"],module_id:3,project_id:c.project_id,page:"project_member",type:"add_panel"},function(){obj.reset_member()})},member_edit:function(e){var t=$(e).data("lang");Strack.get_datagrid_select_data("#team_datagrid_box",function(e){Strack.item_operate_dialog(t,{mode:"modify",field_list_type:["edit"],module_id:3,project_id:c.project_id,page:"project_member",type:"update_panel",primary_id:e.join(",")},function(){obj.reset_member()})})},member_delete:function(e){Strack.ajax_grid_delete("team_datagrid_box","id",StrackLang.Delete_Member_Notice,StatusPHP.deleteProjectMember)},reset_member:function(){$("#team_datagrid_box").datagrid("reload")},nav_auto_save:function(e){var t=$(e);a=t.hasClass("active")?(t.removeClass("active"),t.find("i").removeClass("icon-checked").addClass("icon-unchecked"),!1):(t.addClass("active"),t.find("i").removeClass("icon-unchecked").addClass("icon-checked"),!0)},nav_save:function(e){m()},select_module:function(e){var t,a,i=$(e).data("tabname"),s={module_id:$(e).data("moduleid"),module_name:$(e).data("modulename"),module_type:$(e).data("moduletype"),module_code:$(e).data("modulecode"),template_id:c.template_id,filter:""};switch($(".nation-items").removeClass("admin-bid-ac"),$(e).addClass("admin-bid-ac"),i){case"status":d=s,(a=$("#status_config")).hasClass("visible")||(a.addClass("visible"),$("#status_config_notice").hide(),a.find(".p-status-allow").show(),a.find(".p-status-now").show()),u();break;case"step":r=s,(t=$("#step_config")).hasClass("visible")||(t.addClass("visible"),$("#step_config_notice").hide(),t.find(".p-status-allow").show(),t.find(".p-status-now").show()),h()}},status_add:function(e){Strack.open_dialog("dialog",{title:StrackLang.Add_Status_Title,width:480,height:400,content:Strack.dialog_dom({type:"normal",hidden:[],items:[{case:1,id:"Mstatus_name",type:"text",lang:StrackLang.Name,name:"name",valid:"1,128",value:""},{case:1,id:"Mstatus_code",type:"text",lang:StrackLang.Code,name:"code",valid:"1,128",value:""},{case:2,id:"Mstatus_color",lang:StrackLang.Color,name:"color",valid:"6,6"},{case:2,id:"Mstatus_Icon",lang:StrackLang.Icon,name:"icon",valid:"1,24"},{case:2,id:"Mstatus_Cponds",lang:StrackLang.Corresponds,name:"corresponds",valid:1}],footer:[{obj:"status_submit",type:1,title:StrackLang.Submit},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){Strack.color_pick_widget("#Mstatus_color","hex","light","",320),Strack.combobox_widget("#Mstatus_Icon",{url:StrackPHP.getIconList,valueField:"icon",textField:"icon",formatter:function(e){return'<div class="combo-icons-warp" style="overflow: hidden"><div class="combo-icons aign-left"><i class="'+e.icon+'"></i></div><div class="combo-name">'+e.icon+"</div></div>"}}),Strack.combobox_widget("#Mstatus_Cponds",{url:StrackPHP.getStatusCorresponds,valueField:"id",textField:"name"}),$("#Mstatus_code").inputmask("alphaDash")},close:function(){}})},status_submit:function(e){Strack.ajax_dialog_form("#st_dialog_form .dialog-widget-val","",ProjectPHP.addStatus,{back:function(e){200===parseInt(e.status)?(Strack.dialog_cancel(),d.filter=e.data.name,$("#status_search").val(e.data.name),u(),Strack.top_message({bg:"g",msg:e.message})):layer.msg(e.message,{icon:7,time:1200,anim:6})}})},filter_status:function(e){d.filter=$("#status_search").val(),u()},add_status_to_drag:function(e){var t,a,i,s=$(e).attr("data-statusid");"no"===$(e).attr("data-checked")?(t="icon-uniF068",a="yes",$("#status_drag_list").find(".temp-setlist-no").remove(),i=o[s],$("#status_drag_list").prepend(v(i)),p()):(t="icon-uniF067",a="no",$("#drag_status_item_"+s).remove(),0===$(".drag-status-item").length&&$("#status_drag_list").empty().append('<div class="temp-setlist-no"><p>'+StrackLang.Please_Select_One_Status+"</p></div>")),$(e).attr("data-checked",a),$(e).empty().append('<i class="'+t+'"></i>')},drag_status_save:function(e){f()},drag_status_auto_save:function(e){var t=$(e);i=t.hasClass("active")?(t.removeClass("active"),t.find("i").removeClass("icon-checked").addClass("icon-unchecked"),!1):(t.addClass("active"),t.find("i").removeClass("icon-unchecked").addClass("icon-checked"),!0)},step_add:function(e){Strack.open_dialog("dialog",{title:StrackLang.Add_Step_Title,width:480,height:320,content:Strack.dialog_dom({type:"normal",hidden:[],items:[{case:1,id:"Mstep_name",type:"text",lang:StrackLang.Name,name:"name",valid:"1,128",value:""},{case:1,id:"Mstep_code",lang:StrackLang.Code,name:"code",valid:"1,128",value:""},{case:2,id:"Mstep_color",lang:StrackLang.Color,name:"color",valid:"6,6"}],footer:[{obj:"step_submit",type:1,title:StrackLang.Update},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){Strack.color_pick_widget("#Mstep_color","hex","light","",320),$("#Mstep_code").inputmask("alphaDash")},close:function(){}})},step_submit:function(e){Strack.ajax_dialog_form("#st_dialog_form .dialog-widget-val","",ProjectPHP.addStep,{back:function(e){200===parseInt(e.status)?(Strack.dialog_cancel(),r.filter=e.data.name,$("#step_search").val(e.data.name),h(),Strack.top_message({bg:"g",msg:e.message})):layer.msg(e.message,{icon:7,time:1200,anim:6})}})},filter_step:function(e){r.filter=$("#step_search").val(),h()},add_step_to_drag:function(e){var t,a,i,s=$(e).attr("data-stepid");"no"===$(e).attr("data-checked")?(t="icon-uniF068",a="yes",$("#step_drag_list").find(".temp-setlist-no").remove(),i=l[s],$("#step_drag_list").prepend(k(i)),S()):(t="icon-uniF067",a="no",$("#drag_step_item_"+s).remove(),0===$(".drag-step-item").length&&$("#step_drag_list").empty().append('<div class="temp-setlist-no"><p>'+StrackLang.Please_Select_One_Step+"</p></div>")),$(e).attr("data-checked",a),$(e).empty().append('<i class="'+t+'"></i>')},drag_step_save:function(e){b()},drag_step_auto_save:function(e){var t=$(e);s=t.hasClass("active")?(t.removeClass("active"),t.find("i").removeClass("icon-checked").addClass("icon-unchecked"),!1):(t.addClass("active"),t.find("i").removeClass("icon-unchecked").addClass("icon-checked"),!0)},nav_add_disk:function(e){Strack.open_dialog("dialog",{title:StrackLang.Add_Entity_Disk_Title,width:480,height:370,content:Strack.dialog_dom({type:"normal",hidden:[],items:[{case:1,id:"Ndisk_name",type:"text",lang:StrackLang.Name,name:"name",valid:"",value:""},{case:1,id:"Ndisk_code",type:"text",lang:StrackLang.Code,name:"code",valid:"",value:""},{case:1,id:"Nwin_path",type:"text",lang:StrackLang.Win_Path,name:"win_path",valid:"",value:""},{case:1,id:"Nmac_path",type:"text",lang:StrackLang.Mac_Path,name:"mac_path",valid:"",value:""},{case:1,id:"Nlinux_path",type:"text",lang:StrackLang.Linux_Path,name:"linux_path",valid:"",value:""}],footer:[{obj:"submit_add_disk",type:1,title:StrackLang.Submit},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){}})},submit_add_disk:function(){Strack.ajax_dialog_form("#st_dialog_form .dialog-widget-val","",StrackPHP.addProjectDisk,{back:function(e){var t;200===parseInt(e.status)?($("#overview_disk").find(".combobox-f").each(function(){t=$(this).attr("id"),$("#"+t).combobox("reload")}),Strack.dialog_cancel(),Strack.top_message({bg:"g",msg:e.message})):layer.msg(e.message,{icon:7,time:1200,anim:6})}})}};var c=Strack.generate_hidden_param(),n={},a=!1,o={},i=!1,d={},l={},s=!1,r={};function t(e){switch($(".media-m-item").removeClass("media-m-w-active").each(function(){$(this).data("tab")===e&&$(this).addClass("media-m-w-active")}),function(e,t){var a=c.project_id+".html";t&&(a+="?"+t);history.replaceState(null,e,a)}(e,"tab="+e),e){case"details":Strack.load_info_panel({id:"#project_base_info",mask:"project_info",pos:"max",url:StrackPHP.getProjectInfo,data:c,loading_type:"white"},function(e){var t=e.media_data;t.link_id=c.project_id,t.module_id=c.module_id,t.param.icon="icon-uniF1ED",Strack.thumb_media_widget("#project_base_thumb",t)});break;case"team":Strack.load_grid_columns("#team_datagrid_main",{loading_id:".team_datagrid_main",page:"project_member",module_id:3,project_id:c.project_id,view_type:"grid",temp_fields:{add:{},cut:{}}},function(e){var t={filter:{temp_fields:{add:{},cut:{}},group:e.grid.group_name,sort:e.grid.sort_config.sort_query,request:[],filter_input:e.grid.filter_config.filter_input,filter_panel:e.grid.filter_config.filter_panel,filter_advance:e.grid.filter_config.filter_advance},page:"project_member",module_id:3,project_id:c.project_id},a={url:ProjectPHP.getProjectTeamMembers,height:Strack.panel_height(".p-group-full",0),view:scrollview,rowheight:50,differhigh:!1,singleSelect:!1,adaptive:{dom:".p-group-full",min_width:680,exth:0,domresize:1},multiSort:!0,DragSelect:!0,moduleId:c.module_id,queryParams:{filter_data:JSON.stringify(t)},panelConfig:{active_filter_id:e.grid.filter_config.filter_id},sortConfig:e.grid.sort_config,sortData:e.grid.sort_config.sort_data,toolbarConfig:{id:"team_datagrid_main",page:"project_member",sortAllow:!0,groupAllow:!0,fieldAllow:!0,viewAllow:!0,actionAllow:!0},searchConfig:{id:"team_grid_search",bar_show:e.filter_bar_show,filterBar:{main_dom:"team_datagrid_main",bar_dom:"team_filter_main"}},filterConfig:{id:"team_filter_main",barParam:{}},columnsFieldConfig:e.grid.columnsFieldConfig,frozenColumns:e.grid.frozenColumns,columns:e.grid.columns,toolbar:"#team_tb",pagination:!0,pageNumber:1,pageSize:100,pageList:[100,150],pagePosition:"bottom",showPageList:!1,remoteSort:!1,onDblClickRow:function(e,t){}};e.grid.group_name.length&&(a.groupActive=!0,a.groupField=e.grid.group_name,a.groupFormatter=function(e,t){return'<span class="">'+e+"( "+t.length+" )</span>"}),$("#team_datagrid_box").datagrid(a).datagrid("enableCellEditing").datagrid("disableCellSelecting").datagrid("gotoCell",{index:0,field:"id"}).datagrid("columnMoving")});break;case"navigation":$.ajax({type:"POST",url:ProjectPHP.getProjectNavSetting,dataType:"json",data:{category:"navigation",module_code:c.module_code,module_id:c.module_id,project_id:c.project_id,template_id:c.template_id},beforeSend:function(){n={}},success:function(e){var s=$("#nav_module_list");s.empty();var o=!1;e.forEach(function(e){var t,a;s.append((a="",a+='<li class="text-no-select"><div class="overview-nav-item" data-moduleid="'+(t=e).module_id+'" data-swicthid="'+t.code+'_nav_swicth"><div class="overview-nav-handle aign-left"><i class="icon-uniE6A1"></i></div><div class="overview-nav-icon aign-left"><i class="'+t.icon+'"></i></div><div class="overview-nav-title aign-left"><div class="nav-name text-ellipsis">'+t.name+'</div><div class="nav-description text-ellipsis">'+t.type_name+'</div></div><div class="overview-nav-swicth aign-left"><input id="'+t.code+'_nav_swicth" /></div></div></li>'));var i="yes"===e.checked?1:0;o="project"===e.code||"yes"!==c.rule_navigation_switch_button,n[e.module_id]=e,Strack.init_open_switch({dom:"#"+e.code+"_nav_swicth",disabled:o,value:i,onText:StrackLang.Switch_ON,offText:StrackLang.Switch_OFF,width:100,height:26},function(e){_()})}),"yes"===c.rule_navigation_drag&&Sortable.create(Strack.get_obj_by_id("nav_module_list"),{animation:150,forceFallback:!0,filter:".overview-nav-swicth",onEnd:function(e){_()}})}});break;case"status":case"step":g(e);break;case"disk":$.ajax({type:"POST",url:ProjectPHP.getProjectDiskConfig,data:JSON.stringify(c),dataType:"json",contentType:"application/json",beforeSend:function(){$("#overview_disk").prepend(Strack.loading_dom("white","","disk"))},success:function(s){Strack.combobox_widget("#disk_global_combobox",{url:StrackPHP.getDiskCombobox,prompt:StrackLang.Please_Select_Disk,valueField:"id",textField:"name",value:s.disk_config.global,width:300,height:30,onSelect:function(e){y({disk_id:c.disk_id,code:"global"},e)}});var o=$("#entity_disk_list");if(0<s.module_list.length){var n;o.empty();var d="yes"!==c.rule_disk_modify;s.module_list.forEach(function(t){var e,a,i;$.inArray(t.code,["project"])<0&&(n=s.disk_config[t.code]?s.disk_config[t.code]:"",o.append((a="",i="disk_"+(e=t).code,a+='<div class="ui grid disk-setting-item"><div class="two column row"><div class="five wide column"><span class="title">'+e.name+'</span></div><div class="eleven wide column combobox"><input id="'+i+'" autocomplete="off"/></div></div></div>')),Strack.combobox_widget("#disk_"+t.code,{url:StrackPHP.getDiskCombobox,prompt:StrackLang.Please_Select_Disk,valueField:"id",textField:"name",disabled:d,value:n,width:300,height:30,onSelect:function(e){t.disk_id=c.disk_id,y(t,e)}}))})}$("#st-load_disk").remove()}})}$(".pitem-wrap").removeClass("active").each(function(){$(this).data("tab")===e&&$(this).addClass("active")})}function _(){a&&m()}function m(){var e,t=0,a=[];$(".overview-nav-item").each(function(){e=Strack.get_switch_val("#"+$(this).attr("data-swicthid")),t=$(this).attr("data-moduleid"),1===parseInt(e)&&a.push(n[t])}),$.ajax({type:"POST",url:ProjectPHP.modifyTemplateConfig,data:JSON.stringify({category:"navigation",module_code:c.module_code,module_id:c.module_id,project_id:c.project_id,template_id:c.template_id,config:a}),dataType:"json",contentType:"application/json",beforeSend:function(){$("#tab_navigation").prepend(Strack.loading_dom("white","","navigation"))},success:function(e){Strack.top_message({bg:"g",msg:e.message}),$("#st-load_navigation").remove(),200===parseInt(e.status)&&(e.data.forEach(function(e){n[e.module_id]=e}),Strack.refresh_top_menu(e.menu_data))}})}function g(s){var e=$("#"+s+"_module_list");$.ajax({url:ProjectPHP.getProjectOverviewModuleList,type:"POST",dataType:"json",data:{tab_name:s,template_id:c.template_id},beforeSend:function(){e.append(Strack.loading_dom("white","","module"))},success:function(t){var i="";["fixed","entity"].forEach(function(e){t[e]&&(i+='<li class="module-items-title">'+t[e].title+"</li>",t[e].data.forEach(function(e){var t,a;i+=(a="",a+='<a href="javascript:;" class="nation-items" onclick="obj.select_module(this)" data-tabname="'+s+'" data-moduleid="'+(t=e).id+'" data-modulename="'+t.name+'" data-moduletype="'+t.type+'" data-modulecode="'+t.code+'"><div class="nation-items-wrap"><div class="aign-left"><i class="'+t.icon+' icon-left"></i><span>'+t.name+"</span></div></div></a>")}))}),e.empty().append(i),$("#st-load_module").remove()}})}function u(){$.ajax({url:ProjectPHP.getProjectOverviewStatusList,type:"POST",dataType:"json",data:d,beforeSend:function(){o={},$("#module_status_list").append(Strack.loading_dom("white","","module_status"))},success:function(e){var a="",i=e.status_list;["blocked","not_started","in_progress","daily","done","hide"].forEach(function(t){0<i[t].data.length&&(a+='<li class="module-items-title">'+i[t].title+"</li>",i[t].data.forEach(function(e){e.corresponds_lang=i[t].title,a+=function(e){var t="",a="yes"===e.checked?"icon-uniF068":"icon-uniF067";t+='<li class="nation-items"><div class="nation-items-wrap"><div class="aign-left"><i class="'+e.icon+' icon-left" style="color:#'+e.color+'"></i>'+e.name+"</div>","yes"===c.rule_status_save&&(t+='<a href="javascript:;" onclick="obj.add_status_to_drag(this);" class="aign-right" data-statusid="'+e.id+'" data-checked="'+e.checked+'"><i class="'+a+'"></i></a>');return t+="</div></li>"}(e),o[e.id]=e}))}),0<a.length?$("#module_status_list").empty().append(a):$("#module_status_list").empty().append('<div class="temp-setlist-no"><p>'+StrackLang.Datagird_No_Data+"</p></div>");var t="";e.status_checked.forEach(function(e){console.log(e),t+=v(e)}),0<t.length?($("#status_drag_list").empty().append(t),"yes"===c.rule_status_drag&&p()):$("#status_drag_list").empty().append('<div class="temp-setlist-no"><p>'+StrackLang.Please_Select_One_Status+"</p></div>")}})}function p(){Sortable.create(Strack.get_obj_by_id("status_drag_list"),{animation:150,forceFallback:!0,onEnd:function(e){i&&f()}})}function v(e){var t="";return t+='<li class="text-no-select"><div id="drag_status_item_'+e.id+'" class="drag-status-item" data-statusid="'+e.id+'"><div class="overview-nav-handle aign-left"><i class="icon-uniE6A1"></i></div><div class="overview-nav-icon aign-left"><i class="'+e.icon+'" style="color:#'+e.color+'"></i></div><div class="overview-nav-title aign-left"><div class="nav-name text-ellipsis">'+e.name+'</div><div class="nav-description text-ellipsis">'+e.corresponds_lang+"</div></div></div></li>"}function f(){var e=[];$(".drag-status-item").each(function(){e.push({id:$(this).attr("data-statusid")})}),d.new_status_config=e,$.ajax({type:"POST",url:ProjectPHP.modifyModuleStatusConfig,data:JSON.stringify(d),dataType:"json",contentType:"application/json",beforeSend:function(){$("#status_config").prepend(Strack.loading_dom("white","","status"))},success:function(e){200===parseInt(e.status)?Strack.top_message({bg:"g",msg:e.message}):Strack.top_message({bg:"r",msg:e.message}),$("#st-load_status").remove()}})}function h(){$.ajax({url:ProjectPHP.getProjectOverviewStepList,type:"POST",dataType:"json",data:r,beforeSend:function(){l={},$("#module_step_list").append(Strack.loading_dom("white","","module_step"))},success:function(e){var t="";e.step_list.forEach(function(e){t+=function(e){var t="",a="yes"===e.checked?"icon-uniF068":"icon-uniF067";t+='<li class="nation-items"><div class="nation-items-wrap"><div class="aign-left"><span class="nation-items-label icon-left" style="background-color:#'+e.color+'"></span>'+e.name+"</div>","yes"===c.rule_step_save&&(t+='<a href="javascript:;" onclick="obj.add_step_to_drag(this);" class="aign-right" data-stepid="'+e.id+'" data-checked="'+e.checked+'"><i class="'+a+'"></i></a>');return t+="</div></li>"}(e),l[e.id]=e}),0<t.length?$("#module_step_list").empty().append(t):$("#module_step_list").empty().append('<div class="temp-setlist-no"><p>'+StrackLang.Datagird_No_Data+"</p></div>");var a="";e.step_checked.forEach(function(e){a+=k(e)}),0<a.length?($("#step_drag_list").empty().append(a),"yes"===c.rule_step_drag&&S()):$("#step_drag_list").empty().append('<div class="temp-setlist-no"><p>'+StrackLang.Please_Select_One_Step+"</p></div>")}})}function k(e){var t="";return t+='<li class="text-no-select"><div id="drag_step_item_'+e.id+'" class="drag-step-item" data-stepid="'+e.id+'"><div class="overview-nav-handle aign-left"><i class="icon-uniE6A1"></i></div><div class="overview-nav-icon aign-left" style="background-color:#'+e.color+'"></div><div class="overview-nav-title aign-left"><div class="nav-name text-ellipsis">'+e.name+'</div><div class="nav-description text-ellipsis">'+e.code+"</div></div></div></li>"}function S(){Sortable.create(Strack.get_obj_by_id("step_drag_list"),{animation:150,forceFallback:!0,onEnd:function(e){s&&b()}})}function b(){var e=[],t=0;$(".drag-step-item").each(function(){t=$(this).attr("data-stepid"),e.push(l[t])}),r.new_step_config=e,$.ajax({type:"POST",url:ProjectPHP.modifyModuleStepConfig,data:JSON.stringify(r),dataType:"json",contentType:"application/json",beforeSend:function(){$("#step_config").prepend(Strack.loading_dom("white","","step"))},success:function(e){200===parseInt(e.status)?Strack.top_message({bg:"g",msg:e.message}):Strack.top_message({bg:"r",msg:e.message}),$("#st-load_step").remove()}})}function y(e,t){console.log(e),console.log(t),$.ajax({type:"POST",url:ProjectPHP.modifyProjectDisk,data:JSON.stringify({param:e,data:t}),dataType:"json",contentType:"application/json",beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){$.messager.progress("close"),200===parseInt(e.status)?Strack.top_message({bg:"g",msg:e.message}):layer.msg(e.message,{icon:7,time:1200,anim:6})}})}Strack.listen_keyboard_event(function(e){"enter"===e.code&&($("#status_search").is(":focus")&&obj.filter_status(Strack.get_obj_by_id("search_status_bnt")),$("#step_search").is(":focus")&&obj.filter_step(Strack.get_obj_by_id("search_step_bnt")))}),function(){var e=Strack.read_storage(c.page);e&&Strack.toggle_media_menu(Strack.get_obj_by_id("overview_left_menu"),e);c.url_tab&&c["rule_tab_"+c.url_tab]?t(c.url_tab):t("details")}()});