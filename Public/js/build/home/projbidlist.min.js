$(function(){function t(t,i){var e=Strack.build_filter({project_id:["eq",i]},{},{},{},"and",{},{},[{sortName:"created",sortOrder:"desc"}]);Strack.G.Gfilter_data.bidlist=e;var a=Strack.remove_html_ext(StrackPHP.ProjBidItems);$("#datagrid_box").datagrid({url:BiddingPHP.getBidListData,fitColumns:!1,height:Strack.panel_height(".entity-datalist",0),rowheight:49,differhigh:!1,singleSelect:!1,DragSelect:!0,adaptive:{dom:".entity-datalist",min_width:510,exth:0,domresize:1},queryParams:{filter:JSON.stringify(e),op_type:t,ptype:10020,project_id:i,tab:"bidlist"},frozenColumns:[[{field:"bid_id",title:StrackPHP.ID,checkbox:!0}]],columns:[[{field:"id",title:StrackPHP.ID,align:"center",width:60,frozen:"frozen",findex:0},{field:"bid_icon",title:StrackPHP.Icon,align:"center",width:85,frozen:"frozen",findex:1,formatter:function(t,i,e){return'<a href="'+a+"/"+i.project_id+"_"+i.bid_id+'.html" class="plm-g-player" target="_blank"><i class="icon-uniE95A"></i></a>'}},{field:"export_pdf",title:BiddingPHP.Export_PDF,align:"center",width:85,frozen:"frozen",findex:2,formatter:function(t,i,e){return'<a href="javascript:;" onclick="obj.Export_PDF(this)" class="plm-g-player" data-bidid="'+i.bid_id+'"><i class="icon-uniEADA"></i></a>'}},{field:"bid_name",title:BiddingPHP.Offer_Sheet_Name,align:"center",width:220,frozen:"frozen",findex:3},{field:"currency_name",title:StrackPHP.Currency,align:"center",width:140,frozen:"frozen",findex:4},{field:"discount",title:StrackPHP.Discount,align:"center",width:140,frozen:"frozen",findex:5,formatter:function(t,i,e){return t+"%"}},{field:"quantity",title:BiddingPHP.Quantity,align:"center",width:140,frozen:"frozen",findex:6},{field:"before_tax_price",title:BiddingPHP.Pre-tax_Price,align:"center",width:140,frozen:"frozen",findex:7,formatter:function(t,i,e){return i.currency_icon+" "+t}},{field:"tax",title:BiddingPHP.Taxpoint,align:"center",width:160,frozen:"frozen",findex:8,formatter:function(t,i,e){return t+"%"}},{field:"after_tax_price",title:BiddingPHP.After-tax_Price,align:"center",width:160,frozen:"frozen",findex:9,formatter:function(t,i,e){return i.currency_icon+" "+t}},{field:"exchg_rate",title:BiddingPHP.ExchangeRate,align:"center",width:140,frozen:"frozen",findex:10},{field:"exchg_price",title:BiddingPHP.Final_Price,align:"center",width:160,frozen:"frozen",findex:11,formatter:function(t,i,e){return i.exchg_icon+" "+t}},{field:"created",title:StrackPHP.Created,align:"center",width:140,frozen:"frozen",findex:12}]],toolbar:"#bidlist_tb",pagination:!0,pageSize:100,pageList:[100,200],pageNumber:1,pagePosition:"bottom",remoteSort:!1,onRowContextMenu:function(t,i,e){Strack.grid_clipboard(t.target),t.preventDefault(),$("#st_menu_bidlist").menu("show",{left:t.pageX,top:t.pageY})}}),Strack.SortDown(i,10020,"datagrid_box",{SortChange:"Strack.sort_change",SortAdv:"Strack.DataSortAdv",SortItem:"Strack.DataSortItem"})}obj={addOfferSheet:function(t){var i=$(t).data("pid"),e=$(t).data("grid"),a={type:"bidlist",pid:i,custom:"yes",multi:"no",etype:10020,upmod:"newBidlist"};Strack.open_dialog("dialog",{title:BiddingPHP.Add_Offer_Sheet,width:560,height:360,content:Strack.dialog_dom({type:"normal",hidden:[{case:101,id:"Mup_type",type:"hidden",name:"up_type",valid:1,value:a.upmod},{case:101,id:"Mproject_id",type:"hidden",name:"project_id",valid:1,value:i},{case:101,id:"Mtype",type:"hidden",name:"type",valid:1,value:a.etype},{case:101,id:"Mitype",type:"hidden",name:"type",valid:1,value:"new"}],items:[{case:1,id:"Mup_fields",type:"text",lang:StrackPHP.Fields,name:"fields",valid:1,value:""}],update:!0,footer:[{obj:"BatchUpdate",type:5,title:StrackPHP.Update},{obj:"dialog_cancel",type:8,title:StrackPHP.Cancel}]}),inits:function(){$("#Mup_fields").combobox({url:StrackPHP.EditFields,width:350,valueField:"id",textField:"lang",multiple:!0,value:"",queryParams:a,onSelect:function(t){if(0==$("#dgup_i_"+t.id).length){var e=Strack.BatchUpItem(t,"new");$("#st_dgup").append(e.item_dom),Strack.BatchItemInit(t,i,10020,e.id,a.type,t)}},onUnselect:function(t){$.inArray(t.id,[10021])<0?$("#dgup_i_"+t.id).remove():($(this).combobox("select",t.id),layer.msg(StrackPHP.Must_Field,{icon:2,time:1200,anim:6}))},onLoadSuccess:function(){$(this).combobox("select",10021)}})},close:function(){$("#"+e).datagrid("reload")}})},BathEditBidlist:function(t){var i=$(t).data("grid"),a=($(t).data("ftype"),Strack.GetTaskDatagrid(i,"bid_id",!1));switch(a.verify){case-3:layer.msg(StrackPHP.Please_Select_One,{icon:2,time:1200,anim:6});break;case 200:Strack.BatchUpDialog("#"+i,BiddingPHP.Offer_Sheet_Update_Title,a.ids.join(","),{type:"bidlist",pid:e,custom:"yes",etype:10020,upmod:"bidlist",multi:"no"},StrackPHP.EditFields,a)}},BidlisttoTrash:function(t){var i=$("#datagrid_box").datagrid("getSelections"),a=[];i.forEach(function(t){a.push(t.bid_id)}),Strack.ajax_grid_delete(i,BiddingPHP.DeBidlist_notice,BiddingPHP.DeleteBidlist,{bid_id:a.join(","),pid:e},"#datagrid_box",BiddingPHP.DeBidlistSC)},Export_PDF:function(t){var i=$(t).data("bidid");Strack.open_dialog("dialog",{title:BiddingPHP.Export_PDF,width:480,height:340,content:Strack.dialog_dom({type:"normal",hidden:[{case:101,id:"Mbid_id",type:"hidden",name:"bid_id",valid:1,value:i}],items:[{case:1,id:"Mpdf_name",type:"text",lang:StrackPHP.Name,name:"pdf_name",valid:1,value:""},{case:1,id:"Mstatement_id",lang:BiddingPHP.Statement,name:"statement_id",valid:1,value:""}],footer:[{obj:"doExportPDF",type:1,title:StrackPHP.Update},{obj:"dialog_cancel",type:8,title:StrackPHP.Cancel}]}),inits:function(){Strack.combobox_widget(1,"#Mstatement_id",BiddingPHP.getStatementList,"bid_opt_id","name","",378)}})},doExportPDF:function(){Strack.ajax_dialog_form("#st_dialog_form input",r,BiddingPHP.exportBiddingPDF,{back:function(t){var i=JSON.parse(t),e=i.job_id,a=i.pdf_data;Strack.dialog_cancel(),Strack.open_dialog("dialog",{title:StrackPHP.DownloadPDF,width:380,height:240,content:Strack.dialog_dom({type:"normal",hidden:[{case:101,id:"E_jobid",type:"hidden",name:"job_id",valid:1,value:e}],download:!0,download_arr:{type:"pdf",data:a.job_name,job_id:e},footer:[{obj:"dialog_cancel",type:8,title:StrackPHP.Cancel}]})})}})}};var i=$(".projpage-main");if(PARSE_VAR.auth.authority){var e=$("input[name=proj_id]").val(),a=$("input[name=p_type]").val(),d=Strack.verify_project_data(e),n={},r={};if(r["pdf_name-1"]=BiddingPHP.PDF_Name_Null,r["statement_id-1"]=BiddingPHP.PDF_Statement_Null,d>0){!function(t){for(var i in t){var e=t[i];switch(n[e.alias]=e,e.alias){case"batch_update":case"export_excel":case"bidlist_add":case"bidlist_del":case"bidlist_action":"no"==e.allow&&$(".ah_"+e.alias).remove()}}}(PARSE_VAR.rules),i.show();var o='<a href="'+Strack.remove_html_ext(StrackPHP.ProjBidPend)+"/"+e+'.html" target="_blank"><span class="stp-title">'+BiddingPHP.Pend_Bidding_Data+"</span></a>";$("#url_bidpend").append(o),Strack.project_sub_menu(e,a),function(t){var i=[];"yes"==n.batch_update.allow&&i.push({name:"sedit",text:StrackPHP.Edit_Selected,iconCls:"icon-uniF044",type:"function",click:"obj.BathEditBidlist(this)",attr_data:{pid:t,type:10020,grid:"datagrid_box",mode:"bidlist"}}),"yes"==n.export_excel.allow&&i.push({name:"sexcel",text:StrackPHP.Export_Excel,iconCls:"icon-uniE6082",type:"function",click:"Strack.ExportExcel(this)",attr_data:{pid:t,type:10020,done:"bidlist",mode:"grid"}}),"yes"==n.bidlist_action.allow&&i.push({name:"saction",text:StrackPHP.Action,iconCls:"icon-uniE6BB",type:"function",click:"Strack.ClientActionBatch(this)",attr_data:{type:10020,grid:"datagrid_box",field:"bid_id"}}),i.push({name:"sreset",text:StrackPHP.Reset,iconCls:"icon-uniE682",type:"function",click:"Strack.ResetDatagrid(this)",attr_data:{type:10020,pid:t,grid:"datagrid_box"}}),"yes"==n.bidlist_del.allow&&i.push({name:"sdelete",text:StrackPHP.DeleteSelect,iconCls:"icon-uniE9D5",type:"function",click:"obj.BidlisttoTrash(this)",attr_data:{}}),i.push({name:"scopy_cell",text:StrackPHP.Copy_Grip_Cell,iconCls:"icon-uniE943",type:"function",click:"Strack.copy_clipboard(this)",attr_data:{"clipboard-action":"copy","clipboard-target":"#grid_clipboard"}}),Strack.InitMenuItem("st_menu_bidlist",i),new Clipboard("#st_menu_scopy_cell")}(e),t(a,e)}else i.empty().append(Strack.ProjWarn(StrackPHP.Project_None_Warning)).show()}else i.empty().append(Strack.ProjWarn(StrackPHP.NoPermission)).show()});