$(function(){obj={auth_role_add:function(){Strack.open_dialog("dialog",{title:StrackLang.Add_Auth_Role,width:480,height:240,content:Strack.dialog_dom({type:"normal",items:[{case:1,id:"Nname",lang:StrackLang.Name,name:"name",valid:"1,128",value:""},{case:1,id:"Ncode",lang:StrackLang.Code,name:"code",valid:"1,128",value:""}],footer:[{obj:"role_add_submit",type:1,title:StrackLang.Submit},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),close:function(){}})},role_add_submit:function(){Strack.ajax_dialog_form("#st_dialog_form .dialog-widget-val","",RolePHP.addAuthRole,{back:function(e){200===parseInt(e.status)?(Strack.dialog_cancel(),obj.auth_role_filter(),Strack.top_message({bg:"g",msg:e.message})):layer.msg(e.message,{icon:7,time:1200,anim:6})}})},auth_role_modify:function(e){var a=$(e).data("roleid"),t=$(e).data("name"),i=$(e).data("code");Strack.open_dialog("dialog",{title:StrackLang.Modify_Auth_Role,width:480,height:240,content:Strack.dialog_dom({type:"normal",hidden:[{case:101,id:"Mauth_role_id",type:"hidden",name:"id",valid:1,value:a}],items:[{case:1,id:"Mauth_role_name",type:"text",lang:StrackLang.Name,name:"name",valid:1,value:t},{case:1,id:"Mauth_role_code",type:"text",lang:StrackLang.Code,name:"code",valid:1,value:i}],footer:[{obj:"modify_auth_role",type:1,title:StrackLang.Update},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),close:function(){}})},modify_auth_role:function(){Strack.ajax_dialog_form("#st_dialog_form .dialog-widget-val","",RolePHP.modifyAuthRole,{back:function(e){200===parseInt(e.status)?(Strack.dialog_cancel(),obj.auth_role_filter(),Strack.top_message({bg:"g",msg:e.message})):layer.msg(e.message,{icon:7,time:1200,anim:6})}})},auth_role_delete:function(e){var a=$(e).data("roleid");Strack.ajax_base_delete(a,StrackLang.Delete_AuthRole_Notice,RolePHP.deleteAuthRole,function(e){obj.auth_role_filter()})},auth_role_filter:function(){var e=$("#search_val").val(),a="";0<e.length&&(a=JSON.stringify({name:["LIKE","%"+e+"%"]})),obj.reset_right_panel(),i(a)},select_auth_role:function(e){var a=$(e).data("roleid"),t=$(e).data("name"),i=$(e).data("code");$(".temp-setlist-no").hide(),$(".temp-setlists").show(),$("#hide_role_id").val(a),$("#hide_role_name").val(t),$("#hide_role_code").val(i),$(".role-items").removeClass("templates-active"),$(e).closest(".role-items").addClass("templates-active"),obj.reset_right_rule_panel(),r("project",a)},select_role_tab:function(e){var a=$("#hide_role_id").val(),t=$(e).data("tab");obj.reset_right_rule_panel(),r(t,a)},select_module:function(e){var a=$("#hide_role_id").val(),t=$(e).data("tab"),i={role_id:a,id:$(e).data("id"),code:$(e).data("code"),template_id:$(e).data("templateid"),module_id:$(e).data("moduleid"),mode:t};$(".nation-items").removeClass("admin-bid-ac"),$(e).addClass("admin-bid-ac");var o,l,r,d,n=$("#content_right_"+t);n.find(".temp-content-right-no").hide(),n.find(".temp-content-right-wrap").show(),o=t,l=i,$("#hide_role_rule_id").val(l.id),$("#hide_role_rule_code").val(l.code),$("#hide_role_template_id").val(l.template_id),$("#hide_role_module_id").val(l.module_id),_("function",o),r=l,d=o,$.ajax({url:RolePHP.getAuthRuleChild,type:"POST",dataType:"json",data:r,beforeSend:function(){$("#content_right_func").append(Strack.loading_dom("white","","module_item"))},success:function(e){$("#st-load_module_item").remove();var a=[];e.view&&(a.push("view"),$("#rule_"+d+"_function_list").tree({data:function(e){var a=[],t={};for(var i in e)t={id:e[i].id,code:i,text:e[i].lang,checked:e[i].checked,state:"open",children:[]},e[i].list.forEach(function(e){t.children.push({id:e.id,text:e.lang,checked:e.checked,code:e.code})}),a.push(t);return[{id:"all",text:StrackLang.Check_All,state:"open",children:a}]}(e.view),checkbox:!0}));var t=$("#rule_item_tab_field"),i=$("#rule_project_field_list");if(e.column){a.push("column"),t.show();var o=$("#rule_tab_project_field");if(o.addClass("active"),i.hasClass("datagrid-f"))i.treegrid("loadData",c(e.column));else{var l=c(e.column);i.treegrid({data:l,idField:"id",treeField:"lang",dataGridType:"treegrid",headerAddCheckbox:!0,rowheight:36,height:Strack.panel_height(".role-rule-wrap",0),adaptive:{dom:".role-rule-wrap",min_width:1004,exth:0},columns:[[{field:"lang",title:StrackLang.Authority,width:220},{field:"view",title:StrackLang.Check,width:120,align:"center",formatter:function(e,a,t){return s("view",a,e)}},{field:"create",title:StrackLang.Create,width:120,align:"center",formatter:function(e,a,t){return s("create",a,e)}},{field:"clear",title:StrackLang.Clear,width:120,align:"center",formatter:function(e,a,t){return s("clear",a,e)}},{field:"modify",title:StrackLang.Modify,width:120,align:"center",formatter:function(e,a,t){return s("modify",a,e)}},{field:"delete",title:StrackLang.Delete,width:120,align:"center",formatter:function(e,a,t){return s("delete",a,e)}}]],onAfterRender:function(e){Strack.init_rule_grid_data(e)}})}o.removeClass("active")}else t.hide();$("#hide_role_rule_tab").val(a.join(","))}})},toggle_rule_tab:function(e){_($(e).data("tab"),$(e).data("from"))},auth_module_tab_save:function(){var e={};$("#hide_role_param input").each(function(){e[$(this).attr("name")]=$(this).val()});var a={},t=e.role_rule_tab.split(",");if(0<=$.inArray("view",t)){var i=$("#rule_project_function_list"),o=i.tree("getRoot"),l=i.tree("getChecked"),r=[];l.forEach(function(e){r.push(e.code)});var d={},n=!1,c=!1;o.children.forEach(function(a){n=0<=$.inArray(a.code,r),d[a.code]={id:a.id,lang:a.text,checked:n,list:[]},a.children.forEach(function(e){c=0<=$.inArray(e.code,r),d[a.code].list.push({lang:e.text,code:e.code,id:e.id,checked:c})})}),a.view=d}if(0<=$.inArray("column",t)){var s={},_="",u="",h=!1;$("#rule_tab_project_field .dg-rule-checkbox").each(function(){"single"===$(this).data("pos")&&(_=$(this).data("parent")+"_"+$(this).data("code"),u=$(this).data("field"),h=!!$(this).find(".tree-checkbox").hasClass("tree-checkbox1"),s[_]||(s[_]={}),s[_][u]=h)});var m={},g={},f={};$("#rule_project_field_list").treegrid("getRoots").forEach(function(a){m[a.code]={id:a.id,lang:a.lang,list:[]},a.children.forEach(function(e){g=s[a.code+"_"+e.code],f={view:{lang:e.view.lang,checked:g.view},create:{lang:e.create.lang,checked:g.create},modify:{lang:e.modify.lang,checked:g.modify},delete:{lang:e.delete.lang,checked:g.delete},clear:{lang:e.clear.lang,checked:g.clear}},m[a.code].list.push({lang:e.lang,code:e.code,id:e.id,permission:f})})}),a.column=m}$.ajax({url:RolePHP.saveAuthRoleAuth,type:"POST",dataType:"json",data:JSON.stringify({param:e,config:a}),contentType:"application/json",beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){$.messager.progress("close"),200===parseInt(e.status)?Strack.top_message({bg:"g",msg:e.message}):layer.msg(e.message,{icon:7,time:1200,anim:6})}})},search_project_template:function(e){var a=$("#role_search_box").val();t=0<a.length?{name:["-lk","%"+a+"%"]}:"",obj.reset_right_rule_panel(),o()},reset_right_rule_panel:function(){$(".temp-content-right-no").show(),$(".temp-content-right-wrap").hide()},reset_right_panel:function(){$(".temp-setlist-no").show(),$(".temp-setlists").hide()}};var t="";function i(e){$.ajax({url:RolePHP.getAuthRoleList,type:"POST",dataType:"json",data:{filter:e},beforeSend:function(){$("#auth_role_list").empty().append(Strack.loading_dom("null"))},success:function(e){var i="",a=$("#auth_role_list"),t=$("#role_id").val();e.rows.forEach(function(e){var a,t;i+=(t="",t+='<li id="role_id_'+(a=e).auth_role_id+'" class="role-items" ><div class="role-name text-ellipsis aign-left"><a href="javascript:;" onclick="obj.select_auth_role(this);" data-roleid="'+a.auth_role_id+'" data-name="'+a.name+'" data-code="'+a.code+'">'+a.name+'</a></div><div class="role-bnt aign-right"><a href="javascript:;" class="aign-left" onclick="obj.auth_role_modify(this);" data-roleid="'+a.auth_role_id+'" data-name="'+a.name+'" data-code="'+a.code+'"><i class="icon-uniE684"></i></a><a href="javascript:;" class="aign-left" onclick="obj.auth_role_delete(this);" data-roleid="'+a.auth_role_id+'"><i class="icon-uniE6DB"></i></a></div></li>')}),i?($("#pactive_notice").remove(),a.append(i)):0===$("#pactive_notice").length&&a.before('<div id="pactive_notice" class="datagrid-empty-no">'+StrackLang.Datagird_No_Data+"</div>"),0<t&&$("#role_id_"+t).addClass("templates-active"),$("#st-load").remove()}})}function o(){$.ajax({url:RolePHP.getAuthProjectModuleData,type:"POST",dataType:"json",data:JSON.stringify({filter:t}),contentType:"application/json",beforeSend:function(){$("#project_module").append(Strack.loading_dom("white","","module"))},success:function(a){var t="";for(var i in a)t+='<li class="module-items-title"><i class="icon-uniF1ED icon-left"></i>'+a[i].lang+"</li>",a[i].list.forEach(function(e){t+=l(e,"project",a[i])});$("#auth_module_list").empty().append(t),$("#st-load_module").remove()}})}function l(e,a,t){var i="",o=0,l=0;return"project"===a&&(o=t.template_id,l=e.module_id),i+='<a href="javascript:;" class="nation-items" onclick="obj.select_module(this)" data-id="'+e.id+'" data-code="'+e.code+'" data-tab="'+a+'" data-templateid="'+o+'" data-moduleid="'+l+'"><div class="nation-items-wrap"><div class="aign-left"><span>'+e.lang+"</span></div></div></a>"}function c(e){var a=[],t={};for(var i in e)t={id:e[i].id,lang:e[i].lang,code:i,is_parent:"yes",state:"open",children:[]},e[i].list.forEach(function(e){t.children.push({id:e.id,code:e.code,lang:e.lang,is_parent:"no",parent_code:i,view:e.permission.view,create:e.permission.create,modify:e.permission.modify,clear:e.permission.clear,delete:e.permission.delete})}),a.push(t);return a}function s(e,a,t){if("yes"===a.is_parent)return'<a href="javascript:;" onclick="Strack.rule_grid_header_checkbox(this)" class="dg-rule-checkbox" style="margin-right: 5px" data-pos="parent" data-field="'+e+'" data-code="'+a.code+'"><div class="tree-checkbox tree-checkbox0"></div></a>';var i=t.checked?"tree-checkbox1":"tree-checkbox0";return'<a href="javascript:;" onclick="Strack.rule_grid_header_checkbox(this)" class="dg-rule-checkbox" style="margin-right: 5px" data-pos="single" data-field="'+e+'" data-parent="'+a.parent_code+'" data-code="'+a.code+'"><div class="tree-checkbox '+i+'"></div></a>'}function r(e,a){switch($("#hide_role_tab").val(e),$(".group-item").each(function(){$(this).data("tab")===e?$(this).addClass("active"):$(this).removeClass("active")}),$(".admin-group-content").removeClass("active"),$("#tab_"+e).addClass("active"),e){case"project":o();break;case"front":$.ajax({url:RolePHP.getAuthFrontModuleData,type:"POST",dataType:"json",beforeSend:function(){$("#field_module").append(Strack.loading_dom("white","","module"))},success:function(a){var t="";for(var i in a)t+='<li class="module-items-title">'+a[i].lang+"</li>",a[i].list.forEach(function(e){t+=l(e,"front",a[i])});$("#front_module_list").empty().append(t),$("#st-load_module").remove()}});break;case"admin":$.ajax({url:RolePHP.getAuthAdminModuleData,type:"POST",dataType:"json",beforeSend:function(){$("#field_module").append(Strack.loading_dom("white","","module"))},success:function(a){var t="";for(var i in a)t+='<li class="module-items-title">'+a[i].lang+"</li>",a[i].list.forEach(function(e){t+=l(e,"admin",a[i])});$("#admin_module_list").empty().append(t),$("#st-load_module").remove()}})}}function _(e,a){var t=$("#content_right_"+a);t.find(".admin-rule-content").removeClass("active"),$("#rule_tab_"+a+"_"+e).addClass("active"),t.find(".group-rule-item").each(function(){$(this).data("tab")===e?$(this).addClass("active"):$(this).removeClass("active")})}i(""),Strack.listen_keyboard_event(function(e){"enter"===e.code&&$("#tab_project").hasClass("active")&&($("#role_search_box").is(":focus")&&obj.search_project_template(Strack.get_obj_by_id("search_template_bnt")),$("#search_val").is(":focus")&&obj.auth_role_filter(Strack.get_obj_by_id("search_auth_role")))})});