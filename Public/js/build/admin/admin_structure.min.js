$(function(){function t(){$.ajax({type:"POST",url:StructurePHP.getStructureList,dataType:"json",beforeSend:function(){$("#structure_list").empty().append(Strack.loading_dom("null"))},success:function(t){var a="",i=$("#structure_list"),d=$("#hide_info_id").val();t.forEach(function(t){a+=e(t)}),a?($("#pactive_notice").remove(),i.append(a)):0==$("#pactive_notice").length&&i.before('<div id="pactive_notice" class="datagrid-empty-no">'+StructurePHP.No_Structure_List+"</div>"),d>0&&$("#sinfo_id_"+d).addClass("templates-active"),$("#st-load").remove()}})}function e(t){var e="";return e+='<li id="sinfo_id_'+t.structure_info_id+'" class="templates-items" ><a href="javascript:;" onclick="obj.select_structure(this);" data-infoid="'+t.structure_info_id+'" data-name="'+t.name+'" data-code="'+t.code+'">'+t.name+"</a></li>"}function a(t,e){t.forEach(function(t){c.push({module_id:t.moduleid,structure_id:t.structureid,parent_id:e}),t.children&&t.children.length>0&&a(t.children,t.moduleid)})}function i(t){$.ajax({type:"POST",url:StructurePHP.getStructureModuleList,dataType:"json",data:{structure_info_id:t},beforeSend:function(){$("#module_wrap").append(Strack.loading_dom("white","","module")),$("#structure_wrap").append(Strack.loading_dom("white","","structure"))},success:function(t){var e="";["assembly","entity","base"].forEach(function(a){e+='<li class="module-items-title">'+a+"</li>",t.module_list[a].forEach(function(t){e+=r(t)})}),$("#module_list").empty().append(e),$("#st-load_module").remove(),$("#structure_graph").empty(),t.structure_list.length&&d(t.structure_list,""),$("#st-load_structure").remove()}})}function d(t,e){var a=$("#structure_graph"),i=Math.floor(1e3*Math.random()+1);t.forEach(function(t){var r=a.children(".dd-list");if(0==parseInt(t.parent_id))r.length>0?r.append(n(t,i)):a.empty().append('<ol class="dd-list">'+n(t,i)+"</ol>");else{var c=$("#moduleid_"+t.parent_id+"_"+e),u=c.children(".dd-list");u.length>0?u.append(n(t,i)):c.append('<ol class="dd-list">'+n(t,i)+"</ol>")}t.children&&t.children.length>0&&d(t.children,i)})}function r(t){var e,a="",i="";return t.structure_id&&"base"!=t.type?(e="icon-uniF068",i="y"):(e="icon-uniF067",i="n"),a+='<li class="nation-items"><div class="nation-items-wrap"><div class="aign-left"><i class="'+t.icon+' icon-left"></i><span>'+t.name+'</span></div><a id="mlist_'+t.module_id+'" href="javascript:;" onclick="obj.join_structure(this);" class="aign-right" data-moduleid="'+t.module_id+'" data-exist="'+i+'" data-modulename="'+t.name+'" data-moduletype="'+t.type+'"><i class="'+e+'"></i></a></div></li>'}function n(t,e){var a="";return a+='<li id="moduleid_'+t.module_id+"_"+e+'" class="dd-item dd3-item" data-structureid="'+t.structure_id+'" data-moduleid="'+t.module_id+'" data-random="'+e+'"><div class="dd-handle dd3-handle"></div><a href="javascript:;" class="dd-delete" onclick="obj.delete_item(this)" data-structureid="'+t.structure_id+'" data-moduleid="'+t.module_id+'" data-moduletype="'+t.type+'" data-random="'+e+'"><i class="icon-uniE6DB"></i></a><div class="dd3-content">'+t.name+"</div></li>"}obj={structure_add:function(){Strack.open_dialog("dialog",{title:StructurePHP.Add_Structure_Title,width:480,height:280,content:Strack.dialog_dom({type:"normal",items:[{case:1,id:"name",lang:StrackPHP.Name,name:"name",valid:"1,128",value:""},{case:1,id:"code",lang:StrackPHP.Code,name:"code",valid:"1,128",value:""}],footer:[{obj:"structure_add_submit",type:1,title:StrackPHP.Submit},{obj:"dialog_cancel",type:8,title:StrackPHP.Cancel}]}),close:function(){t()}})},structure_add_submit:function(){Strack.ajax_dialog_form("#st_dialog_form input","",StructurePHP.addStructure,{back:function(t){200==parseInt(t.status)?(Strack.dialog_cancel(),Strack.top_message({bg:"g",msg:t.message})):layer.msg(t.message,{icon:7,time:1200,anim:6})}})},structure_modify:function(){var e=$("#hide_info_id").val(),a=$("#hide_info_name").val(),i=$("#hide_info_code").val();Strack.open_dialog("dialog",{title:StructurePHP.Modify_Structure_Title,width:480,height:240,content:Strack.dialog_dom({type:"normal",hidden:[{case:101,id:"Minfo_id",type:"hidden",name:"structure_info_id",valid:1,value:e}],items:[{case:1,id:"name",lang:StrackPHP.Name,name:"name",valid:"1,128",value:a},{case:1,id:"code",lang:StrackPHP.Code,name:"code",valid:"1,128",value:i}],footer:[{obj:"structure_modify_submit",type:1,title:StrackPHP.Update},{obj:"dialog_cancel",type:8,title:StrackPHP.Cancel}]}),close:function(){t()}})},structure_modify_submit:function(){Strack.ajax_dialog_form("#st_dialog_form input","",StructurePHP.modifyStructure,{back:function(t){200==parseInt(t.status)?(Strack.dialog_cancel(),Strack.top_message({bg:"g",msg:t.message})):layer.msg(t.message,{icon:7,time:1200,anim:6})}},{extra:function(t){return $("#hide_info_name").val(t.name),$("#hide_info_code").val(t.code),t}})},select_structure:function(t){var e=$(t).attr("data-infoid"),a=$(t).attr("data-name"),d=$(t).attr("data-code");$("#hide_info_id").val(e),$("#hide_info_name").val(a),$("#hide_info_code").val(d),$(".templates-items").removeClass("templates-active"),$(t).parent().addClass("templates-active"),i(e)},join_structure:function(t){var e=$(t).data("moduleid"),a=$(t).data("modulename"),i=$(t).data("moduletype"),d=$(t).attr("data-exist"),r=$("#structure_graph"),c={structure_id:0,module_id:e,name:a,type:i};if("n"==d){var u=r.children(".dd-list"),o=Math.floor(1e3*Math.random()+1);u.length>0?u.prepend(n(c,o)):r.empty().append('<ol class="dd-list">'+n(c,o)+"</ol>"),"base"!=i&&$("#mlist_"+e).attr("data-exist","y").html('<i class="icon-uniF068"></i>')}},delete_item:function(t){var e=parseInt($(t).data("structureid")),a=$(t).data("moduletype"),i=$(t).data("random"),d=parseInt($(t).data("moduleid")),r=$("#moduleid_"+d+"_"+i),n=r.children(".dd-list").html();r.before(n).remove(),"base"!=a&&$("#mlist_"+d).attr("data-exist","n").html('<i class="icon-uniF067"></i>'),e>0&&$.ajax({type:"POST",url:StructurePHP.deleteStructure,dataType:"json",data:{structure_id:e}})},structure_save:function(){var t=$("#hide_info_id").val(),e=$("#structure_graph").nestable("serialize");c=[],a(e,0),c.length>0?$.ajax({type:"POST",url:StructurePHP.saveStructure,dataType:"json",data:{structure_info_id:t,structure:JSON.stringify(c)},success:function(t){Strack.top_message({bg:"g",msg:t.message})}}):layer.msg(StructurePHP.Please_Select_Module,{icon:7,time:1200,anim:6})}};var c=[];t(),$("#structure_graph").nestable()});